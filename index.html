<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡ˆä»¶é€²åº¦è¿½è¹¤ç³»çµ± (Master v10)</title>
    <style>
        :root {
            --primary: #0f766e;
            --primary-light: #ccfbf1;
            --bg: #f3f4f6;
            --sidebar-bg: #ffffff;
            --text-main: #111827;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; background-color: var(--bg); color: var(--text-main);
            height: 100vh; display: flex; overflow: hidden;
        }

        /* --- Auth Screen --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 999;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .mode-switch-container {
            position: absolute; top: 20px; right: 20px;
            display: flex; gap: 10px;
        }
        .mode-btn {
            padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border);
            background: white; cursor: pointer; font-size: 0.9rem; font-weight: 500;
            transition: all 0.2s;
        }
        .mode-btn.active {
            background: var(--primary); color: white; border-color: var(--primary);
        }

        .auth-box {
            background: white; padding: 2.5rem; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 320px;
            text-align: center; border: 1px solid var(--border);
            position: relative;
        }
        .auth-tag {
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            background: var(--warning); color: white; padding: 2px 12px;
            border-radius: 10px; font-size: 0.75rem; font-weight: bold;
            display: none;
        }
        .auth-box.admin-view .auth-tag { display: block; }
        .auth-box input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box;
        }
        .auth-btn {
            width: 100%; padding: 12px; background: var(--primary);
            color: white; border: none; border-radius: 8px; cursor: pointer;
            margin-top: 10px; font-weight: 600; font-size: 1rem;
        }
        .switch-auth {
            margin-top: 15px; font-size: 0.9rem; color: var(--text-light);
            cursor: pointer; text-decoration: underline;
        }

        /* --- Main Layout --- */
        #app-screen { display: flex; width: 100%; height: 100%; }

        aside {
            width: 280px; background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 1.5rem; box-sizing: border-box;
        }
        .user-profile {
            display: flex; align-items: center; gap: 10px;
            padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }
        .avatar {
            width: 40px; height: 40px; background: var(--primary);
            color: white; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; font-weight: bold;
        }
        .logout-link { font-size: 0.8rem; color: var(--danger); cursor: pointer; margin-top: 2px;}

        /* Admin Buttons */
        .admin-btn {
            padding: 10px; border-radius: 6px; text-align: center;
            cursor: pointer; font-weight: 600; margin-bottom: 10px;
            display: none; font-size: 0.9rem;
        }
        .btn-perm { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .btn-perm:hover { background: #ffedd5; }
        
        .btn-stats { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        .btn-stats:hover { background: #dbeafe; }

        .sidebar-section h3 {
            font-size: 0.85rem; text-transform: uppercase;
            color: var(--text-light); letter-spacing: 1px; margin-bottom: 1rem;
        }
        input[type="date"] {
            width: 100%; padding: 8px; border: 1px solid var(--border);
            border-radius: 6px; color: var(--text-main); box-sizing: border-box;
        }
        
        /* Search Box */
        .search-box input {
            width: 100%; padding: 8px; border: 1px solid var(--border);
            border-radius: 6px; box-sizing: border-box; margin-bottom: 10px;
        }
        .search-results {
            list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto;
        }
        .search-item {
            padding: 8px; font-size: 0.85rem; border-bottom: 1px solid #f3f4f6; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .search-item:hover { background: #f9fafb; color: var(--primary); }
        .search-date { font-size: 0.75rem; color: #9ca3af; }

        .history-list {
            list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1;
        }
        .history-item {
            padding: 10px; cursor: pointer; border-radius: 6px;
            color: var(--text-main); margin-bottom: 4px;
            display: flex; justify-content: space-between;
        }
        .history-item:hover { background: #f8fafc; }
        .history-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }

        main { flex-grow: 1; padding: 2rem; overflow-y: auto; position: relative; }
        header { margin-bottom: 2rem; }
        header h1 { margin: 0; font-size: 1.8rem; color: #111827; }
        .date-header { color: var(--text-light); margin-bottom: 0.5rem; font-weight: 500; }

        /* Progress Bar */
        .overall-progress-container {
            margin-top: 15px; background: white; padding: 15px; border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; color: #4b5563; }
        .progress-track { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.5s ease; }

        /* Task List */
        .task-container { max-width: 900px; padding-bottom: 100px; }
        .category-group { margin-bottom: 2.5rem; }
        .category-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .cat-title { color: var(--primary); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; }
        .badge-count { background: #e5e7eb; color: #374151; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; margin-left: 10px; }
        .cat-progress-track { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; margin-bottom: 1rem; }
        .cat-progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease; }

        .category-group.overdue-section .cat-title { color: #dc2626; } 
        .category-group.completed-section .cat-title { color: var(--text-light); }
        .category-group.deleted-section .cat-title { color: var(--danger); }
        .category-group.completed-section .task-item { background-color: #f9fafb; opacity: 0.9; }
        .category-group.deleted-section .task-item { background-color: #fff1f2; opacity: 0.8; }

        /* Task Card */
        .task-item {
            background: white; padding: 1rem; border-radius: 8px;
            margin-bottom: 0.8rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex; align-items: flex-start; transition: all 0.2s;
            border-left: 4px solid transparent; position: relative;
        }
        .task-item:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); transform: translateY(-1px); }
        
        .task-item[data-cat="å®šåºæ”¶ä»¶"] { border-left-color: #3b82f6; }
        .task-item[data-cat="å¼•å­é€ä»¶"] { border-left-color: #8b5cf6; }
        .task-item[data-cat="ç”¢å‰æ”¶ä»¶"] { border-left-color: #ec4899; }
        .task-item[data-cat="æ¥­å‹™äº¤è¾¦äº‹é …"] { border-left-color: #f59e0b; }
        .task-item.completed-item { border-left-color: #9ca3af; }
        .task-item.deleted-item { border-left-color: #ef4444; }

        @keyframes blink-alert {
            0% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.2); border-left-color: #ef4444; }
            50% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); border-left-color: #b91c1c; background-color: #fef2f2; }
            100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.2); border-left-color: #ef4444; }
        }
        .task-item.overdue-item {
            animation: blink-alert 2s infinite ease-in-out;
            border-left-width: 6px;
        }
        .overdue-item .task-title { font-weight: 800; color: #b91c1c; }

        .task-checkbox {
            width: 22px; height: 22px; border: 2px solid #cbd5e1;
            border-radius: 5px; margin-right: 15px; cursor: pointer;
            flex-shrink: 0; display: grid; place-items: center; transition: 0.2s; margin-top: 3px;
        }
        .task-checkbox:hover { border-color: var(--primary); }
        
        .task-content { flex-grow: 1; display: flex; flex-direction: column; padding-right: 30px; }
        
        .task-title { 
            font-size: 1rem; line-height: 1.5; word-break: break-all; 
            padding: 2px 4px; border-radius: 4px; cursor: pointer;
        }
        .task-title:hover { background: #f3f4f6; color: var(--primary); } 
        
        .task-meta { font-size: 0.8rem; color: var(--text-light); margin-top: 6px; line-height: 1.4; }
        .completed-info { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; display: inline-block; font-weight: 500; }
        
        .task-overdue-date {
            display: inline-block; background-color: #ef4444; color: white;
            font-size: 0.75rem; padding: 2px 8px; border-radius: 4px;
            margin-top: 5px; font-weight: 500;
        }

        .task-item.completed-item .task-checkbox { background: var(--text-light); border-color: var(--text-light); }
        .task-item.completed-item .task-checkbox::after { content: 'âœ“'; color: white; font-size: 14px; }
        .task-item.completed-item .task-title { color: #9ca3af; text-decoration: line-through; cursor: default; font-weight: normal; }

        .action-area { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 2px 8px; color: #9ca3af; border-radius: 4px; }
        .btn-icon:hover { background-color: #f3f4f6; color: var(--text-main); }
        .btn-delete:hover { color: var(--danger); }
        .btn-restore { color: var(--success); font-size: 1rem; }
        .history-dot { width: 24px; height: 24px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #9ca3af; font-weight: bold; font-size: 18px; }
        .history-dot:hover { background: #e5e7eb; color: var(--primary); }

        /* FAB */
        .fab {
            position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px;
            background: var(--primary); color: white; border-radius: 50%; font-size: 32px;
            border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.05); background: #0d9488; }

        /* Modals */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 100; justify-content: center; align-items: center;
        }
        .modal-card {
            background: white; padding: 2rem; border-radius: 12px;
            width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-height: 90vh; overflow-y: auto;
        }
        
        /* Editor */
        .editor-toolbar {
            display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap;
            padding: 8px; background: #f8fafc; border: 1px solid #e2e8f0;
            border-bottom: none; border-radius: 6px 6px 0 0; align-items: center;
        }
        .tool-btn {
            padding: 4px 8px; border: 1px solid #cbd5e1; background: white;
            border-radius: 4px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center;
        }
        .tool-btn:hover { background: #f1f5f9; }
        .color-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 1px solid #ddd; }
        .separator { width: 1px; height: 20px; background: #cbd5e1; margin: 0 4px; }
        select.tool-select { padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; }

        #inputTitle {
            width: 100%; min-height: 100px; padding: 15px; 
            border: 1px solid #d1d5db; border-radius: 0 0 6px 6px; 
            box-sizing: border-box; font-size: 1rem;
            background: white; outline: none; overflow-y: auto;
        }
        #inputTitle:focus { border-color: var(--primary); }
        .input-group { margin-bottom: 1.2rem; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
        .input-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }

        .modal-btns { display: flex; justify-content: flex-end; gap: 12px; margin-top: 1.5rem; }
        .btn { padding: 9px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.95rem; }
        .btn-cancel { background: #f3f4f6; color: #4b5563; }
        .btn-save { background: var(--primary); color: white; }

        /* User Management List */
        .user-list { list-style: none; padding: 0; margin: 0; }
        .user-item {
            display: flex; flex-direction: column;
            padding: 15px; border-bottom: 1px solid #eee; background: #fafafa; border-radius: 6px; margin-bottom: 10px;
        }
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .user-name { font-weight: 600; font-size: 1rem; }
        .user-role-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; border: 1px solid #ddd;}
        .role-senior { background: #fef3c7; color: #b45309; border-color: #fcd34d; }
        .role-admin { background: #e0f2fe; color: #0369a1; border-color: #7dd3fc; }
        .role-user { background: #f3f4f6; color: #4b5563; border-color: #d1d5db; }
        
        .user-edit-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .user-edit-row input { flex-grow: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .user-edit-row select { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .readonly-text { color: #666; font-style: italic; padding: 6px 0; }
        .btn-approve { background: #10b981; color: white; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; }
        .btn-reject { background: #ef4444; color: white; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 5px;}

        /* Stats Styles */
        .stats-filter-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .stats-filter-row input, .stats-filter-row select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
        .stats-result-area { max-height: 400px; overflow-y: auto; }
        .stat-card { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .stat-header { font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .stat-bar-container { margin-bottom: 8px; }
        .stat-label { font-size: 0.8rem; color: #666; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .stat-track { height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--primary); }

        /* Logs */
        .log-list { list-style: none; padding: 0; margin: 0; }
        .log-item { padding: 10px 0; border-bottom: 1px solid #f1f5f9; display: flex; gap: 10px; font-size: 0.9rem; }
        .log-time { color: var(--text-light); min-width: 120px; font-size: 0.8rem; }
        .log-content { color: var(--text-main); }
        .log-user { font-weight: 600; color: var(--primary); }

        @media (max-width: 768px) {
            aside { display: none; }
            #app-screen { flex-direction: column; }
            .modal-card { width: 90%; }
        }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="mode-switch-container">
        <button class="mode-btn active" id="btnModeGeneral" onclick="switchMode('general')">ä¸€èˆ¬æ¨¡å¼</button>
        <button class="mode-btn" id="btnModeAdmin" onclick="switchMode('admin')">ç®¡ç†æ¨¡å¼</button>
    </div>

    <div class="auth-box" id="authBox">
        <div class="auth-tag">ADMIN MODE</div>
        <h2 id="auth-title" style="color:#0f766e">ç³»çµ±ç™»å…¥</h2>
        <input type="text" id="username" placeholder="å¸³è™Ÿ" autofocus>
        <input type="password" id="password" placeholder="å¯†ç¢¼">
        <button class="auth-btn" id="btnAuthAction" onclick="handleAuth()">ç™»å…¥</button>
        
        <div class="switch-auth" id="switchAuthLink" onclick="toggleAuthMode()">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Šæ–°å¸³è™Ÿ</div>
    </div>
</div>

<div id="app-screen" style="display:none;">
    <aside>
        <div class="user-profile">
            <div class="avatar" id="userAvatar">U</div>
            <div>
                <div style="font-weight: 600;" id="displayUsername">User</div>
                <div class="logout-link" onclick="logout()">ç™»å‡ºå¸³è™Ÿ</div>
            </div>
        </div>

        <div class="admin-btn btn-perm" id="adminPanelBtn" onclick="openUserModal()">ğŸ‘¥ æˆå“¡æ¬Šé™ç®¡ç†</div>
        <div class="admin-btn btn-stats" id="statsPanelBtn" onclick="openStatsModal()">ğŸ“Š ä»»å‹™å®Œæˆçµ±æ•´</div>

        <div class="sidebar-section">
            <h3>ğŸ” æœå°‹ä»»å‹™</h3>
            <div class="search-box">
                <input type="text" id="searchTaskInput" placeholder="è¼¸å…¥é—œéµå­—..." oninput="handleSearch()">
                <ul class="search-results" id="searchResults"></ul>
            </div>
        </div>

        <div class="sidebar-section">
            <h3>ğŸ“… æ—¥æœŸé¸æ“‡</h3>
            <input type="date" id="dateSearch" onchange="changeDate(this.value)">
        </div>

        <div class="sidebar-section" style="flex-grow: 1; display:flex; flex-direction:column; margin-top:20px;">
            <h3>ğŸ•’ æœ€è¿‘æª¢è¦–ç´€éŒ„</h3>
            <ul class="history-list" id="historyList"></ul>
        </div>
    </aside>

    <main>
        <header>
            <div class="date-header" id="headerDateDisplay"></div>
            <h1>æ¡ˆä»¶é€²åº¦ç®¡ç†</h1>
            <div class="overall-progress-container">
                <div class="progress-label">
                    <span>ç•¶æ—¥ç¸½å®Œæˆåº¦</span>
                    <span id="overallProgressText">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="overallProgressBar" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <div class="task-container" id="taskListContainer"></div>

        <button class="fab" onclick="openModal()">+</button>
    </main>
</div>

<div class="modal-overlay" id="taskModal">
    <div class="modal-card">
        <h2 style="margin-top:0; color:#111827;" id="modalTitle">æ–°å¢æ¡ˆä»¶/ä»»å‹™</h2>
        <div class="input-group">
            <label>ä»»å‹™å…§å®¹ (é¸å–æ–‡å­—å¯ç·¨è¼¯æ¨£å¼)</label>
            <div class="editor-toolbar">
                <button class="tool-btn" onclick="formatDoc('bold')" title="ç²—é«”"><b>B</b></button>
                <div class="separator"></div>
                <button class="tool-btn" onclick="formatDoc('foreColor', '#ef4444')" title="ç´…å­—"><span class="color-dot" style="background:#ef4444"></span></button>
                <button class="tool-btn" onclick="formatDoc('foreColor', '#2563eb')" title="è—å­—"><span class="color-dot" style="background:#2563eb"></span></button>
                <button class="tool-btn" onclick="formatDoc('foreColor', '#10b981')" title="ç¶ å­—"><span class="color-dot" style="background:#10b981"></span></button>
                <button class="tool-btn" onclick="formatDoc('foreColor', '#000000')" title="é»‘å­—"><span class="color-dot" style="background:#000000"></span></button>
                <div class="separator"></div>
                <button class="tool-btn" onclick="formatDoc('hiliteColor', '#fecaca')" title="ç´…åº•" style="background:#fecaca">A</button>
                <button class="tool-btn" onclick="formatDoc('hiliteColor', '#bfdbfe')" title="è—åº•" style="background:#bfdbfe">A</button>
                <button class="tool-btn" onclick="formatDoc('hiliteColor', '#bbf7d0')" title="ç¶ åº•" style="background:#bbf7d0">A</button>
                <button class="tool-btn" onclick="formatDoc('hiliteColor', '#ffffff')" title="ç„¡åº•" style="background:#fff">âœ•</button>
                <div class="separator"></div>
                <select class="tool-select" onchange="formatDoc('fontSize', this.value); this.value='';" title="å­—é«”å¤§å°">
                    <option value="">å­—é«”å¤§å°</option>
                    <option value="2">å°</option>
                    <option value="3">ä¸­</option>
                    <option value="5">å¤§</option>
                    <option value="7">ç‰¹å¤§</option>
                </select>
            </div>
            <div id="inputTitle" contenteditable="true" placeholder="è¼¸å…¥å…§å®¹..."></div>
        </div>
        <div class="input-group">
            <label>æ­¸å±¬é …ç›®</label>
            <select id="inputCategory">
                <option value="å®šåºæ”¶ä»¶">ğŸ“‚ å®šåºæ”¶ä»¶</option>
                <option value="å¼•å­é€ä»¶">ğŸš€ å¼•å­é€ä»¶</option>
                <option value="ç”¢å‰æ”¶ä»¶">ğŸ“¦ ç”¢å‰æ”¶ä»¶</option>
                <option value="æ¥­å‹™äº¤è¾¦äº‹é …">ğŸ“‹ æ¥­å‹™äº¤è¾¦äº‹é …</option>
            </select>
        </div>
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" id="btnSaveTask" onclick="saveTask()">ç¢ºèª</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="historyModal">
    <div class="modal-card" style="width: 400px;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“‹ ç·¨è¼¯/æ“ä½œç´€éŒ„</h3>
        <ul class="log-list" id="logList"></ul>
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="document.getElementById('historyModal').style.display='none'">é—œé–‰</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="userModal">
    <div class="modal-card" style="width: 650px;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ‘¥ æˆå“¡æ¬Šé™ç®¡ç†</h3>
        <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">é«˜ç´šç®¡ç†è€…å¯ç·¨è¼¯æ‰€æœ‰è³‡æ–™ï¼›ç®¡ç†è€…åƒ…èƒ½æ ¸å‡†æ–°å¸³è™Ÿã€‚</p>
        <ul class="user-list" id="userListDisplay"></ul>
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="document.getElementById('userModal').style.display='none'">é—œé–‰</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="statsModal">
    <div class="modal-card" style="width: 700px;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“Š ä»»å‹™å®Œæˆçµ±æ•´</h3>
        <div class="stats-filter-row">
            <div>
                <label style="font-size:0.8rem; display:block;">é–‹å§‹æ—¥æœŸ</label>
                <input type="date" id="statsDateStart">
            </div>
            <div>
                <label style="font-size:0.8rem; display:block;">çµæŸæ—¥æœŸ</label>
                <input type="date" id="statsDateEnd">
            </div>
            <div>
                <label style="font-size:0.8rem; display:block;">æª¢ç´¢å¸³è™Ÿ</label>
                <select id="statsUserSelect">
                    <option value="all">-- æ‰€æœ‰å¸³è™Ÿ (ç¸½è¦½) --</option>
                </select>
            </div>
            <div style="display:flex; align-items:flex-end;">
                <button class="btn btn-save" onclick="updateStats()">æŸ¥è©¢</button>
            </div>
        </div>
        <div class="stats-result-area" id="statsResultDisplay">
            </div>
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="document.getElementById('statsModal').style.display='none'">é—œé–‰</button>
        </div>
    </div>
</div>

<script>
    const DB_KEY_TASKS = 'tasktrack_v10_tasks';
    const DB_KEY_USERS = 'tasktrack_v10_users';
    const DB_KEY_CURRENT_USER = 'tasktrack_v10_current'; 
    const DB_KEY_HISTORY = 'tasktrack_v10_history';

    const ORDERED_CATEGORIES = ["å®šåºæ”¶ä»¶", "å¼•å­é€ä»¶", "ç”¢å‰æ”¶ä»¶", "æ¥­å‹™äº¤è¾¦äº‹é …"];

    let state = {
        currentUser: null,
        authMode: 'general', 
        currentDate: getTodayStr(),
        tasks: JSON.parse(localStorage.getItem(DB_KEY_TASKS)) || [],
        users: JSON.parse(localStorage.getItem(DB_KEY_USERS)) || [],
        history: JSON.parse(localStorage.getItem(DB_KEY_HISTORY)) || [],
        editingTaskId: null
    };

    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function formatDoc(cmd, value) { document.execCommand(cmd, false, value); document.getElementById('inputTitle').focus(); }

    /* --- Auth Logic --- */
    function switchMode(mode) {
        state.authMode = mode;
        document.getElementById('btnModeGeneral').className = mode === 'general' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('btnModeAdmin').className = mode === 'admin' ? 'mode-btn active' : 'mode-btn';
        
        const box = document.getElementById('authBox');
        const link = document.getElementById('switchAuthLink');
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('btnAuthAction');

        if (mode === 'admin') {
            box.classList.add('admin-view');
            link.style.display = 'none';
            title.innerText = 'ç®¡ç†å“¡ç™»å…¥';
            btn.innerText = 'ç™»å…¥';
        } else {
            box.classList.remove('admin-view');
            link.style.display = 'block';
            title.innerText = 'ç³»çµ±ç™»å…¥';
            btn.innerText = 'ç™»å…¥';
        }
    }

    function toggleAuthMode() {
        if(state.authMode === 'admin') return;
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('btnAuthAction');
        const isLogin = title.innerText.includes('ç™»å…¥');

        if (isLogin) {
            title.innerText = 'è¨»å†Šæ–°å¸³è™Ÿ';
            btn.innerText = 'è¨»å†Š';
        } else {
            title.innerText = 'ç³»çµ±ç™»å…¥';
            btn.innerText = 'ç™»å…¥';
        }
    }

    function handleAuth() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        const title = document.getElementById('auth-title').innerText;

        if(!u || !p) return alert('è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼');

        // ADMIN LOGIN
        if (state.authMode === 'admin') {
            if (u === 'Admin' && p === 'Abcd1234') {
                loginSuccess(u, 'senior'); 
            } else {
                const user = state.users.find(x => x.username === u && x.password === p);
                if (user && user.isApproved && (user.role === 'admin' || user.role === 'senior')) {
                    loginSuccess(u, user.role);
                } else {
                    alert('æ¬Šé™ä¸è¶³æˆ–å¸³å¯†éŒ¯èª¤ (åƒ…ç®¡ç†è€…å¯å¾æ­¤è™•ç™»å…¥)');
                }
            }
            return;
        }

        // GENERAL LOGIN / REGISTER
        if (title.includes('è¨»å†Š')) {
            if (u.toLowerCase() === 'admin') return alert('ä¸å¯ä½¿ç”¨ Admin ä½œç‚ºå¸³è™Ÿ');
            const exist = state.users.find(x => x.username === u);
            if (exist) return alert('å¸³è™Ÿå·²å­˜åœ¨');
            
            state.users.push({ username: u, password: p, isApproved: false, role: 'user', remarks: '' });
            localStorage.setItem(DB_KEY_USERS, JSON.stringify(state.users));
            alert('è¨»å†ŠæˆåŠŸï¼å¾…ç®¡ç†å“¡æ ¸å‡†å¾Œæ–¹å¯ç™»å…¥ã€‚');
            toggleAuthMode();
        } else {
            const user = state.users.find(x => x.username === u && x.password === p);
            if (!user) return alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
            if (!user.isApproved) return alert('âš ï¸ æ‚¨çš„å¸³è™Ÿå°šæœªé€šéå¯©æ ¸ã€‚');
            
            loginSuccess(u, user.role || 'user');
        }
    }

    function loginSuccess(username, role) {
        state.currentUser = { name: username, role: role };
        localStorage.setItem(DB_KEY_CURRENT_USER, JSON.stringify(state.currentUser));
        initApp();
    }
    function logout() { localStorage.removeItem(DB_KEY_CURRENT_USER); location.reload(); }
    function checkLogin() { const stored = localStorage.getItem(DB_KEY_CURRENT_USER); if (stored) { state.currentUser = JSON.parse(stored); initApp(); } }

    function initApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';
        
        let roleName = '';
        if(state.currentUser.role === 'senior') roleName = ' (é«˜ç´šç®¡ç†è€…)';
        else if(state.currentUser.role === 'admin') roleName = ' (ç®¡ç†è€…)';
        
        document.getElementById('displayUsername').innerText = state.currentUser.name + roleName;
        document.getElementById('userAvatar').innerText = state.currentUser.name[0].toUpperCase();
        
        // Admin Button
        const canManage = state.currentUser.role === 'senior' || state.currentUser.role === 'admin';
        document.getElementById('adminPanelBtn').style.display = canManage ? 'block' : 'none';
        
        // Stats Button (Senior Only)
        document.getElementById('statsPanelBtn').style.display = state.currentUser.role === 'senior' ? 'block' : 'none';

        changeDate(state.currentDate, false);
    }

    /* --- Feature: Search --- */
    function handleSearch() {
        const keyword = document.getElementById('searchTaskInput').value.trim().toLowerCase();
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';

        if (!keyword) return;

        // Strip HTML from titles for searching
        const matched = state.tasks.filter(t => {
            const rawTitle = t.title.replace(/<[^>]*>/g, '');
            return rawTitle.toLowerCase().includes(keyword);
        });

        matched.slice(0, 20).forEach(t => { // limit to 20
            const li = document.createElement('li');
            li.className = 'search-item';
            const rawTitle = t.title.replace(/<[^>]*>/g, '');
            li.innerHTML = `<span>${rawTitle}</span><span class="search-date">${t.date}</span>`;
            li.onclick = () => changeDate(t.date);
            resultsContainer.appendChild(li);
        });
        
        if(matched.length === 0) {
            resultsContainer.innerHTML = '<li class="search-item" style="color:#999; cursor:default;">ç„¡ç›¸ç¬¦çµæœ</li>';
        }
    }

    /* --- Feature: Stats (Senior Only) --- */
    function openStatsModal() {
        const modal = document.getElementById('statsModal');
        const userSelect = document.getElementById('statsUserSelect');
        const startInput = document.getElementById('statsDateStart');
        const endInput = document.getElementById('statsDateEnd');

        // Reset & Populate
        userSelect.innerHTML = '<option value="all">-- æ‰€æœ‰å¸³è™Ÿ (ç¸½è¦½) --</option>';
        const uniqueUsers = [...new Set(state.tasks.filter(t=>t.completed && t.completedBy).map(t=>t.completedBy))];
        uniqueUsers.sort().forEach(u => {
            const opt = document.createElement('option');
            opt.value = u; opt.innerText = u;
            userSelect.appendChild(opt);
        });

        // Default Date: This Year
        const year = new Date().getFullYear();
        startInput.value = `${year}-01-01`;
        endInput.value = `${year}-12-31`;

        updateStats(); // Initial Load
        modal.style.display = 'flex';
    }

    function updateStats() {
        const start = document.getElementById('statsDateStart').value;
        const end = document.getElementById('statsDateEnd').value;
        const selectedUser = document.getElementById('statsUserSelect').value;
        const display = document.getElementById('statsResultDisplay');
        display.innerHTML = '';

        if(!start || !end) return;

        // Filter valid tasks
        const validTasks = state.tasks.filter(t => {
            if(!t.completed || t.isDeleted || !t.completedBy) return false;
            return t.date >= start && t.date <= end;
        });

        if (selectedUser === 'all') {
            // View: Summary by User
            const userCounts = {};
            let total = 0;
            validTasks.forEach(t => {
                if(!userCounts[t.completedBy]) userCounts[t.completedBy] = 0;
                userCounts[t.completedBy]++;
                total++;
            });

            if(total === 0) { display.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æ­¤å€é–“ç„¡å®Œæˆè³‡æ–™</div>'; return; }

            // Sort descending
            const sortedUsers = Object.entries(userCounts).sort((a,b) => b[1] - a[1]);

            sortedUsers.forEach(([user, count]) => {
                const pct = Math.round((count / total) * 100);
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-header"><span>${user}</span> <span>${count} ä»¶</span></div>
                    <div class="stat-bar-container">
                        <div class="stat-label"><span>ä½”æ¯”</span><span>${pct}%</span></div>
                        <div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div>
                    </div>
                `;
                display.appendChild(card);
            });

        } else {
            // View: Detailed breakdown for Specific User
            const userTasks = validTasks.filter(t => t.completedBy === selectedUser);
            const total = userTasks.length;
            
            if(total === 0) { display.innerHTML = `<div style="text-align:center; padding:20px; color:#888;">å¸³è™Ÿ ${selectedUser} åœ¨æ­¤å€é–“ç„¡å®Œæˆè³‡æ–™</div>`; return; }

            const catCounts = {};
            ORDERED_CATEGORIES.forEach(c => catCounts[c] = 0);
            userTasks.forEach(t => {
                if(catCounts[t.category] !== undefined) catCounts[t.category]++;
            });

            const card = document.createElement('div');
            card.className = 'stat-card';
            card.innerHTML = `<div class="stat-header" style="border-bottom:1px solid #eee; padding-bottom:5px;">${selectedUser} - ç¸½è¨ˆ ${total} ä»¶</div>`;
            
            ORDERED_CATEGORIES.forEach(cat => {
                const count = catCounts[cat];
                const pct = total === 0 ? 0 : Math.round((count / total) * 100);
                card.innerHTML += `
                    <div style="margin-top:10px;">
                        <div class="stat-label"><span>${cat}</span><span>${count} (${pct}%)</span></div>
                        <div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div>
                    </div>
                `;
            });
            display.appendChild(card);
        }
    }

    /* --- User Management --- */
    function openUserModal() {
        const list = document.getElementById('userListDisplay');
        const role = state.currentUser.role; 
        list.innerHTML = '';
        
        if (state.users.length === 0) list.innerHTML = '<li style="padding:10px; color:#666;">ç›®å‰ç„¡ä¸€èˆ¬ä½¿ç”¨è€…å¸³è™Ÿã€‚</li>';

        state.users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'user-item';
            const isApproved = user.isApproved;
            
            let badgeClass = 'role-user'; let badgeText = 'ä¸€èˆ¬è€…';
            if(user.role === 'senior') { badgeClass = 'role-senior'; badgeText = 'é«˜ç´šç®¡ç†è€…'; }
            else if(user.role === 'admin') { badgeClass = 'role-admin'; badgeText = 'ç®¡ç†è€…'; }
            if(!isApproved) { badgeClass = ''; badgeText = 'å¾…å¯©æ ¸'; }

            let controlsHtml = '';
            
            if (role === 'senior') {
                const selUser = user.role === 'user' ? 'selected' : '';
                const selAdmin = user.role === 'admin' ? 'selected' : '';
                const selSenior = user.role === 'senior' ? 'selected' : '';
                
                controlsHtml = `
                    <div class="user-edit-row">
                        <select id="role_${user.username}">
                            <option value="user" ${selUser}>ä¸€èˆ¬è€…</option>
                            <option value="admin" ${selAdmin}>ç®¡ç†è€…</option>
                            <option value="senior" ${selSenior}>é«˜ç´šç®¡ç†è€…</option>
                        </select>
                        <input type="text" id="note_${user.username}" placeholder="å‚™è¨»" value="${user.remarks || ''}">
                    </div>
                    <div style="text-align:right;">
                        <button class="btn-approve" onclick="updateUser('${user.username}')">${isApproved?'æ›´æ–°è³‡æ–™':'æ ¸å‡†/æ›´æ–°'}</button>
                        <button class="btn-reject" onclick="deleteUser('${user.username}')">åˆªé™¤</button>
                    </div>
                `;
            } else if (role === 'admin') {
                let actionBtn = '';
                if (!isApproved) actionBtn = `<button class="btn-approve" onclick="approveUserSimple('${user.username}')">æ ¸å‡†ç”³è«‹</button>`;
                else actionBtn = `<span style="color:#10b981; font-size:0.85rem;">å·²æ ¸å‡†</span>`;

                controlsHtml = `
                    <div class="user-edit-row">
                        <span class="readonly-text">è§’è‰²: ${badgeText}</span>
                        <span class="readonly-text" style="margin-left:15px;">å‚™è¨»: ${user.remarks || '(ç„¡)'}</span>
                    </div>
                    <div style="text-align:right;">${actionBtn}</div>
                `;
            }

            li.innerHTML = `<div class="user-header"><div><span class="user-name">${user.username}</span><span class="user-role-badge ${badgeClass}">${badgeText}</span></div></div>${controlsHtml}`;
            list.appendChild(li);
        });
        document.getElementById('userModal').style.display = 'flex';
    }

    function updateUser(username) {
        const user = state.users.find(u => u.username === username);
        if (user) {
            user.role = document.getElementById(`role_${username}`).value;
            user.remarks = document.getElementById(`note_${username}`).value;
            user.isApproved = true; 
            localStorage.setItem(DB_KEY_USERS, JSON.stringify(state.users));
            alert(`å¸³è™Ÿ ${username} è³‡æ–™å·²æ›´æ–°ã€‚`); openUserModal();
        }
    }
    function deleteUser(username) {
        if (!confirm(`é«˜ç´šç®¡ç†å“¡æ“ä½œï¼šç¢ºå®šè¦åˆªé™¤å¸³è™Ÿ ${username} å—ï¼Ÿ`)) return;
        state.users = state.users.filter(u => u.username !== username);
        localStorage.setItem(DB_KEY_USERS, JSON.stringify(state.users)); openUserModal();
    }
    function approveUserSimple(username) {
        const user = state.users.find(u => u.username === username);
        if (user) {
            user.isApproved = true; localStorage.setItem(DB_KEY_USERS, JSON.stringify(state.users));
            alert(`å·²æ ¸å‡†å¸³è™Ÿ ${username}ã€‚`); openUserModal();
        }
    }

    /* --- Core Task Logic --- */
    function renderTasks() {
        const container = document.getElementById('taskListContainer');
        container.innerHTML = '';
        
        // Overdue
        const overdueTasks = state.tasks.filter(t => t.date < state.currentDate && !t.completed && !t.isDeleted);
        if (overdueTasks.length > 0) {
            const overdueGroup = document.createElement('div');
            overdueGroup.className = 'category-group overdue-section';
            overdueGroup.innerHTML = `<div class="category-header-row"><div class="cat-title">ğŸš¨ å…ˆå‰æœªå®Œæˆ <span class="badge-count" style="background:#fee2e2; color:#b91c1c;">${overdueTasks.length}</span></div></div>`;
            overdueTasks.sort((a, b) => new Date(a.date) - new Date(b.date));
            overdueTasks.forEach(task => overdueGroup.appendChild(createTaskElement(task, true))); 
            container.appendChild(overdueGroup);
        }

        // Current
        const dayTasks = state.tasks.filter(t => t.date === state.currentDate);
        const totalActive = dayTasks.filter(t => !t.isDeleted).length;
        const totalDone = dayTasks.filter(t => !t.isDeleted && t.completed).length;
        const totalPct = totalActive === 0 ? 0 : Math.round((totalDone / totalActive) * 100);
        document.getElementById('overallProgressText').innerText = `${totalDone}/${totalActive} (${totalPct}%)`;
        document.getElementById('overallProgressBar').style.width = `${totalPct}%`;

        if (dayTasks.length === 0 && overdueTasks.length === 0) {
            container.innerHTML += `<div style="text-align:center; color:#9ca3b8; margin-top:60px;">æœ¬æ—¥ç„¡ä»»ä½•æ¡ˆä»¶æˆ–ä»»å‹™</div>`; return;
        }

        ORDERED_CATEGORIES.forEach(cat => {
            const catTasksAll = dayTasks.filter(t => t.category === cat && !t.isDeleted);
            const catTasksActive = catTasksAll.filter(t => !t.completed);
            const catPct = catTasksAll.length === 0 ? 0 : Math.round((catTasksAll.filter(t => t.completed).length / catTasksAll.length) * 100);

            const catGroup = document.createElement('div');
            catGroup.className = 'category-group';
            catGroup.innerHTML = `<div class="category-header-row"><div class="cat-title">${cat} <span class="badge-count">${catTasksActive.length}</span></div><div style="font-size:0.8rem; color:#6b7280; font-weight:600;">${catPct}%</div></div><div class="cat-progress-track"><div class="cat-progress-fill" style="width: ${catPct}%"></div></div>`;
            if (catTasksActive.length > 0) catTasksActive.forEach(task => catGroup.appendChild(createTaskElement(task)));
            else catGroup.innerHTML += `<div style="font-size:0.9rem; color:#d1d5db; padding-left:10px; margin-bottom:10px;">ç„¡å¾…è¾¦äº‹é …</div>`;
            container.appendChild(catGroup);
        });

        // Completed
        const completedTasks = dayTasks.filter(t => t.completed && !t.isDeleted);
        if (completedTasks.length > 0) {
            const doneGroup = document.createElement('div');
            doneGroup.className = 'category-group completed-section';
            doneGroup.innerHTML = `<div class="category-header-row"><div class="cat-title">âœ… å·²å®Œæˆ <span class="badge-count">${completedTasks.length}</span></div></div>`;
            completedTasks.sort((a, b) => new Date(a.completedAt) - new Date(b.completedAt));
            completedTasks.forEach(task => doneGroup.appendChild(createTaskElement(task)));
            container.appendChild(doneGroup);
        }

        // Deleted
        const deletedTasks = dayTasks.filter(t => t.isDeleted);
        if (deletedTasks.length > 0) {
            const delGroup = document.createElement('div');
            delGroup.className = 'category-group deleted-section';
            delGroup.innerHTML = `<div class="category-header-row"><div class="cat-title">ğŸ—‘ï¸ è¢«åˆªé™¤é …ç›® <span class="badge-count">${deletedTasks.length}</span></div></div>`;
            deletedTasks.forEach(task => delGroup.appendChild(createTaskElement(task)));
            container.appendChild(delGroup);
        }
    }

    function createTaskElement(task, isOverdue = false) {
        const div = document.createElement('div');
        const overdueClass = isOverdue ? 'overdue-item' : '';
        div.className = `task-item ${overdueClass} ${task.completed ? 'completed-item' : ''} ${task.isDeleted ? 'deleted-item' : ''}`;
        div.setAttribute('data-cat', task.category);

        let checkboxHtml = `<div class="task-checkbox" onclick="toggleTask(${task.id})"></div>`;
        if (task.isDeleted) checkboxHtml = '';

        let metaHtml = '';
        if (task.completed && !task.isDeleted) {
            const dateObj = new Date(task.completedAt);
            const timeStr = `${dateObj.getHours().toString().padStart(2,'0')}:${dateObj.getMinutes().toString().padStart(2,'0')}`;
            const dateStr = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;
            metaHtml = `<div class="task-meta">åŸå§‹åˆ†é¡: ${task.category} <br><span class="completed-info">${task.completedBy} æ–¼ ${dateStr} ${timeStr} å®Œæˆ</span></div>`;
        } else if (isOverdue) {
            metaHtml = `<div class="task-meta"><span class="task-overdue-date">å»ºç«‹æ–¼: ${task.date}</span></div>`;
        }

        let actionBtn = `<button class="btn-icon btn-delete" title="åˆªé™¤" onclick="deleteTask(${task.id})">Ã—</button>`;
        if (task.isDeleted) actionBtn = `<button class="btn-icon btn-restore" title="é‚„åŸ" onclick="restoreTask(${task.id})">â†© é‚„åŸ</button>`;

        const clickEvent = (!task.isDeleted) ? `onclick="openModal(${task.id})"` : '';
        const cursorStyle = task.isDeleted ? 'style="cursor:default"' : '';

        div.innerHTML = `${checkboxHtml}<div class="task-content"><div class="task-title" ${clickEvent} ${cursorStyle}>${task.title}</div>${metaHtml}</div><div class="action-area"><div class="history-dot" onclick="showHistory(${task.id})" title="æŸ¥çœ‹ç´€éŒ„">â‹®</div>${actionBtn}</div>`;
        return div;
    }

    function toggleTask(id) {
        const task = state.tasks.find(t => t.id === id);
        if (task) {
            task.completed = !task.completed;
            if (task.completed) {
                task.completedBy = state.currentUser.name;
                task.completedAt = new Date().toISOString();
                logAction(task, 'å®Œæˆ', 'æ¨™è¨˜ç‚ºå®Œæˆ');
            } else {
                task.completedBy = null;
                task.completedAt = null;
                logAction(task, 'é‡å•Ÿ', 'å–æ¶ˆå®Œæˆç‹€æ…‹');
            }
            saveData(); renderTasks();
        }
    }

    function openModal(taskId = null) {
        const modal = document.getElementById('taskModal');
        const titleEl = document.getElementById('modalTitle');
        const editor = document.getElementById('inputTitle');
        const catSelect = document.getElementById('inputCategory');
        const saveBtn = document.getElementById('btnSaveTask');
        modal.style.display = 'flex'; editor.focus();

        if (taskId) {
            state.editingTaskId = taskId;
            const task = state.tasks.find(t => t.id === taskId);
            titleEl.innerText = 'ç·¨è¼¯ä»»å‹™å…§å®¹';
            editor.innerHTML = task.title;
            catSelect.value = task.category;
            saveBtn.innerText = 'ä¿å­˜ä¿®æ”¹';
        } else {
            state.editingTaskId = null;
            titleEl.innerText = 'æ–°å¢æ¡ˆä»¶/ä»»å‹™';
            editor.innerHTML = '';
            catSelect.value = 'å®šåºæ”¶ä»¶';
            saveBtn.innerText = 'ç¢ºèªæ–°å¢';
        }
    }
    function closeModal() { document.getElementById('taskModal').style.display = 'none'; state.editingTaskId = null; }
    
    function saveTask() {
        const htmlContent = document.getElementById('inputTitle').innerHTML.trim();
        const category = document.getElementById('inputCategory').value;
        const textContent = document.getElementById('inputTitle').innerText.trim();
        if (textContent === '' && !htmlContent.includes('<img')) return alert('è«‹è¼¸å…¥å…§å®¹');

        if (state.editingTaskId) {
            const task = state.tasks.find(t => t.id === state.editingTaskId);
            if (task && (task.title !== htmlContent || task.category !== category)) {
                task.title = htmlContent; task.category = category;
                logAction(task, 'ä¿®æ”¹', 'ç·¨è¼¯ä»»å‹™å…§å®¹/åˆ†é¡');
                saveData(); renderTasks();
            }
        } else {
            const newTask = {
                id: Date.now(), title: htmlContent, category: category, date: state.currentDate,
                completed: false, completedBy: null, completedAt: null, isDeleted: false, logs: []
            };
            logAction(newTask, 'å»ºç«‹', `å»ºç«‹ä»»å‹™æ–¼ [${category}]`);
            state.tasks.push(newTask); saveData(); renderTasks();
        }
        closeModal();
    }
    function deleteTask(id) {
        const task = state.tasks.find(t => t.id === id);
        if(task && confirm('ç¢ºå®šè¦å°‡æ­¤é …ç›®ç§»è‡³è¢«åˆªé™¤é …ç›®å—ï¼Ÿ')) {
            task.isDeleted = true; logAction(task, 'åˆªé™¤', 'ç§»è‡³è¢«åˆªé™¤é …ç›®'); saveData(); renderTasks();
        }
    }
    function restoreTask(id) {
        const task = state.tasks.find(t => t.id === id);
        if(task) { task.isDeleted = false; logAction(task, 'é‚„åŸ', 'å¾åˆªé™¤é …ç›®ä¸­é‚„åŸ'); saveData(); renderTasks(); }
    }
    function changeDate(d, addHistory = true) {
        state.currentDate = d;
        document.getElementById('dateSearch').value = d;
        const dateObj = new Date(d);
        document.getElementById('headerDateDisplay').innerText = dateObj.toLocaleDateString('zh-TW', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        if(addHistory) {
            state.history = state.history.filter(x => x !== d);
            state.history.unshift(d);
            if(state.history.length > 10) state.history.pop();
            localStorage.setItem(DB_KEY_HISTORY, JSON.stringify(state.history));
            renderHistory();
        }
        renderTasks();
    }
    function logAction(task, type, desc) {
        if (!task.logs) task.logs = [];
        task.logs.unshift({ type: type, desc: desc, user: state.currentUser.name, time: new Date().toISOString() });
    }
    function saveData() { localStorage.setItem(DB_KEY_TASKS, JSON.stringify(state.tasks)); }
    function renderHistory() {
        const ul = document.getElementById('historyList'); ul.innerHTML = '';
        state.history.forEach(d => {
            const li = document.createElement('li'); li.className = `history-item ${d === state.currentDate?'active':''}`;
            li.innerText = d; li.onclick = () => changeDate(d, false); ul.appendChild(li);
        });
    }
    function showHistory(id) {
        const task = state.tasks.find(t => t.id === id);
        if (!task) return;
        const list = document.getElementById('logList'); list.innerHTML = '';
        const logs = task.logs || [];
        if (logs.length === 0) list.innerHTML = '<li style="padding:10px; color:#999;">ç„¡æ­·å²ç´€éŒ„</li>';
        else logs.forEach(log => {
            const date = new Date(log.time);
            const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
            const li = document.createElement('li'); li.className = 'log-item';
            li.innerHTML = `<div class="log-time">${timeStr}</div><div class="log-content"><span class="log-user">${log.user}</span> ${log.desc}</div>`;
            list.appendChild(li);
        });
        document.getElementById('historyModal').style.display = 'flex';
    }
    document.getElementById('taskModal').addEventListener('click', e => { if(e.target.id==='taskModal') closeModal(); });
    checkLogin();
</script>
</body>
</html>