<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>æ¡ˆä»¶é€²åº¦è¿½è¹¤ç³»çµ± (LINE Notify v25)</title>

    <script src="https://unpkg.com/firebase@9.22.2/firebase-app-compat.js"></script>
    <script src="https://unpkg.com/firebase@9.22.2/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #0f766e; --primary-light: #ccfbf1; --bg: #f3f4f6;
            --sidebar-bg: #ffffff; --text-main: #111827; --text-light: #6b7280;
            --border: #e5e7eb; --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --genesis: #7e22ce;
            --line-green: #06c755; /* LINE Brand Color */
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* Auth Screen */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .auth-box { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 320px; text-align: center; border: 1px solid var(--border); position: relative; }
        .auth-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: 600; font-size: 1rem; transition: background 0.3s; }
        .auth-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .switch-auth { margin-top: 15px; font-size: 0.9rem; color: var(--text-light); cursor: pointer; text-decoration: underline; }

        /* Layout */
        #app-screen { display: flex; width: 100%; height: 100%; position: relative; }
        #mobile-menu-btn { display: none; position: absolute; top: 15px; left: 15px; z-index: 1100; background: white; border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: var(--primary); }
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }
        aside { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem; box-sizing: border-box; transition: transform 0.3s ease; }
        
        .user-profile { display: flex; align-items: center; gap: 10px; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
        .avatar { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0; }
        .logout-link { font-size: 0.8rem; color: var(--danger); cursor: pointer; margin-top: 2px;}
        
        /* Admin Buttons */
        .admin-btn { padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; font-weight: 600; margin-bottom: 10px; display: none; font-size: 0.9rem; }
        .btn-perm { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .btn-stats { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        .btn-settings { background: #f0fdfa; color: #0f766e; border: 1px solid #ccfbf1; } 
        
        .sidebar-section h3 { font-size: 0.85rem; text-transform: uppercase; color: var(--text-light); letter-spacing: 1px; margin-bottom: 1rem; }
        input[type="date"] { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; color: var(--text-main); box-sizing: border-box; font-family: inherit; }
        .search-box input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }
        .search-results { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .search-item { padding: 8px; font-size: 0.85rem; border-bottom: 1px solid #f3f4f6; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .search-item:hover { background: #f9fafb; color: var(--primary); }
        .history-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .history-item { padding: 10px; cursor: pointer; border-radius: 6px; color: var(--text-main); margin-bottom: 4px; display: flex; justify-content: space-between; }
        .history-item:hover { background: #f8fafc; }
        .history-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }

        main { flex-grow: 1; padding: 2rem; overflow-y: auto; position: relative; }
        header { margin-bottom: 2rem; }
        header h1 { margin: 0; font-size: 1.8rem; color: #111827; }
        .date-header { color: var(--text-light); margin-bottom: 0.5rem; font-weight: 500; }
        .overall-progress-container { margin-top: 15px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; color: #4b5563; }
        .progress-track { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.5s ease; }

        .task-container { max-width: 900px; padding-bottom: 100px; }
        .category-group { margin-bottom: 2.5rem; }
        .category-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .cat-title { color: var(--primary); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; }
        .badge-count { background: #e5e7eb; color: #374151; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; margin-left: 10px; }
        .cat-progress-track { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; margin-bottom: 1rem; }
        .cat-progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease; }

        .category-group.overdue-section .cat-title { color: #dc2626; } 
        .category-group.completed-section .cat-title { color: var(--text-light); }
        .category-group.deleted-section .cat-title { color: var(--danger); }
        .category-group.completed-section .task-item { background-color: #f9fafb; opacity: 0.9; }
        .category-group.deleted-section .task-item { background-color: #fff1f2; opacity: 0.8; }

        .task-item { background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: flex-start; transition: all 0.2s; border-left: 4px solid transparent; position: relative; }
        .task-item:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); transform: translateY(-1px); }
        .task-item[data-cat="å®šåºæ”¶ä»¶"] { border-left-color: #3b82f6; }
        .task-item[data-cat="å¼•å­é€ä»¶"] { border-left-color: #8b5cf6; }
        .task-item[data-cat="ç”¢å‰æ”¶ä»¶"] { border-left-color: #ec4899; }
        .task-item[data-cat="æ¥­å‹™äº¤è¾¦äº‹é …"] { border-left-color: #f59e0b; }
        .task-item[data-cat="NGSæ”¶ä»¶"] { border-left-color: #0d9488; }
        .task-item.completed-item { border-left-color: #9ca3af; }
        .task-item.deleted-item { border-left-color: #ef4444; }

        @keyframes blink-alert {
            0% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.2); border-left-color: #ef4444; }
            50% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); border-left-color: #b91c1c; background-color: #fef2f2; }
            100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.2); border-left-color: #ef4444; }
        }
        .task-item.overdue-item { animation: blink-alert 2s infinite ease-in-out; border-left-width: 6px; }
        .overdue-item .task-title { font-weight: 800; color: #b91c1c; }

        .task-checkbox { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 5px; margin-right: 15px; cursor: pointer; flex-shrink: 0; display: grid; place-items: center; transition: 0.2s; margin-top: 3px; }
        .task-checkbox:hover { border-color: var(--primary); }
        .task-content { flex-grow: 1; display: flex; flex-direction: column; padding-right: 10px; }
        .task-title { font-size: 1rem; line-height: 1.5; word-break: break-all; padding: 2px 4px; border-radius: 4px; cursor: pointer; }
        .task-title:hover { background: #f3f4f6; color: var(--primary); } 
        .task-meta { font-size: 0.8rem; color: var(--text-light); margin-top: 6px; line-height: 1.4; }
        .completed-info { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; display: inline-block; font-weight: 500; }
        .task-overdue-date { display: inline-block; background-color: #ef4444; color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; margin-top: 5px; font-weight: 500; }
        .task-item.completed-item .task-checkbox { background: var(--text-light); border-color: var(--text-light); }
        .task-item.completed-item .task-checkbox::after { content: 'âœ“'; color: white; font-size: 14px; }
        .task-item.completed-item .task-title { color: #9ca3af; text-decoration: line-through; cursor: default; font-weight: normal; }

        /* NGS Detail Badge */
        .ngs-badge { display: inline-block; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; background: #fdfdfd; margin-right: 5px; margin-top: 3px; color: #555; }

        .action-area { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 2px 8px; color: #9ca3af; border-radius: 4px; }
        .btn-icon:hover { background-color: #f3f4f6; color: var(--text-main); }
        .btn-delete:hover { color: var(--danger); }
        .btn-restore { color: var(--success); font-size: 1rem; }
        /* LINE Button specific style */
        .btn-line:hover { color: var(--line-green); }
        
        .history-dot { width: 24px; height: 24px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #9ca3af; font-weight: bold; font-size: 18px; }
        .history-dot:hover { background: #e5e7eb; color: var(--primary); }

        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; font-size: 32px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s; z-index: 800; }
        .fab:hover { transform: scale(1.05); background: #0d9488; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2100; justify-content: center; align-items: center; }
        .modal-card { background: white; padding: 2rem; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow-y: auto; }
        
        .editor-toolbar { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; padding: 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-bottom: none; border-radius: 6px 6px 0 0; align-items: center; }
        .tool-btn { padding: 4px 8px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; margin-bottom: 4px;}
        .color-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 1px solid #ddd; }
        .separator { width: 1px; height: 20px; background: #cbd5e1; margin: 0 4px; }
        select.tool-select { padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; }
        
        #inputTitle { width: 100%; min-height: 80px; padding: 15px; border: 1px solid #d1d5db; border-radius: 0 0 6px 6px; box-sizing: border-box; font-size: 1rem; background: white; outline: none; overflow-y: auto; }
        #inputTitle:focus { border-color: var(--primary); }
        .input-group { margin-bottom: 1.2rem; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
        .input-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }
        .input-group input[type="text"] { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }

        /* NGS FORM STYLES */
        #ngs-form-container { background: #f0fdfa; padding: 15px; border: 1px solid #ccfbf1; border-radius: 8px; margin-bottom: 15px; display: none; }
        .ngs-row { margin-bottom: 10px; }
        .ngs-row label { font-size: 0.85rem; color: #0f766e; font-weight: 600; margin-bottom: 4px; display: block; }
        .ngs-row input, .ngs-row select { width: 100%; padding: 8px; border: 1px solid #5eead4; border-radius: 4px; font-size: 0.95rem; }
        #ngs-extraction-fields, #ngs-qc-fields { margin-top: 10px; padding-left: 10px; border-left: 3px solid #0d9488; display: none; }

        .modal-btns { display: flex; justify-content: flex-end; gap: 12px; margin-top: 1.5rem; }
        .btn { padding: 9px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.95rem; }
        .btn-cancel { background: #f3f4f6; color: #4b5563; }
        .btn-save { background: var(--primary); color: white; }

        .user-list, .settings-list { list-style: none; padding: 0; margin: 0; }
        .user-item, .setting-item { display: flex; flex-direction: column; padding: 15px; border-bottom: 1px solid #eee; background: #fafafa; border-radius: 6px; margin-bottom: 10px; }
        .setting-item { flex-direction: row; justify-content: space-between; align-items: center; }
        
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .user-name { font-weight: 600; font-size: 1rem; }
        .user-role-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; border: 1px solid #ddd;}
        
        .role-creator { background: #f3e8ff; color: #6b21a8; border-color: #d8b4fe; font-weight: bold; }
        .role-senior { background: #fef3c7; color: #b45309; border-color: #fcd34d; }
        .role-admin { background: #e0f2fe; color: #0369a1; border-color: #7dd3fc; }
        .role-user { background: #f3f4f6; color: #4b5563; border-color: #d1d5db; }
        
        .user-edit-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .user-edit-row input { flex-grow: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .user-edit-row select { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .readonly-text { color: #666; font-style: italic; padding: 6px 0; }
        .btn-approve { background: #10b981; color: white; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; }
        .btn-reject { background: #ef4444; color: white; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 5px;}
        .btn-icon-eye { background:none; border:none; cursor:pointer; padding:5px; font-size:1rem; }

        .stats-filter-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .stats-filter-row input, .stats-filter-row select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
        .stats-result-area { max-height: 400px; overflow-y: auto; }
        .stat-card { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .stat-header { font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .stat-bar-container { margin-bottom: 8px; }
        .stat-label { font-size: 0.8rem; color: #666; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .stat-track { height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--primary); }

        .log-list { list-style: none; padding: 0; margin: 0; }
        .log-item { padding: 10px 0; border-bottom: 1px solid #f1f5f9; display: flex; gap: 10px; font-size: 0.9rem; }
        .log-time { color: var(--text-light); min-width: 120px; font-size: 0.8rem; }
        .log-content { color: var(--text-main); }
        .log-user { font-weight: 600; color: var(--primary); }

        @media (max-width: 768px) {
            #mobile-menu-btn { display: block; }
            #sidebar-overlay { display: none; }
            #sidebar-overlay.active { display: block; }
            aside { position: fixed; top: 0; left: 0; height: 100%; width: 280px; z-index: 1000; transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            aside.open { transform: translateX(0); }
            main { padding-top: 70px; width: 100%; }
            .task-item { flex-direction: column; }
            .task-content { padding-right: 0; margin-bottom: 10px; }
            .action-area { flex-direction: row; width: 100%; justify-content: flex-end; }
            .fab { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 28px; }
        }
    </style>
</head>
<body>

<button id="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="auth-screen">
    <div class="auth-box" id="authBox">
        <h2 id="auth-title" style="color:#0f766e">ç³»çµ±ç™»å…¥</h2>
        <input type="text" id="username" placeholder="å¸³è™Ÿ" autofocus>
        <input type="password" id="password" placeholder="å¯†ç¢¼">
        <button class="auth-btn" id="btnAuthAction" onclick="handleAuth()">ç™»å…¥</button>
        <div class="switch-auth" id="switchAuthLink" onclick="toggleAuthMode()">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Šæ–°å¸³è™Ÿ</div>
    </div>
</div>

<div id="app-screen" style="display:none;">
    <aside>
        <div class="user-profile">
            <div class="avatar" id="userAvatar">U</div>
            <div>
                <div style="font-weight: 600;" id="displayUsername">User</div>
                <div class="logout-link" onclick="logout()">ç™»å‡ºå¸³è™Ÿ</div>
            </div>
        </div>
        <div class="admin-btn btn-perm" id="adminPanelBtn" onclick="openUserModal()">ğŸ‘¥ æˆå“¡æ¬Šé™ç®¡ç†</div>
        <div class="admin-btn btn-settings" id="salesSettingsBtn" onclick="openSalesSettings()">âš™ï¸ NGS æ¥­å‹™è¨­å®š</div>
        <div class="admin-btn btn-stats" id="statsPanelBtn" onclick="openStatsModal()">ğŸ“Š ä»»å‹™å®Œæˆçµ±æ•´</div>
        
        <div class="sidebar-section">
            <h3>ğŸ” æœå°‹ä»»å‹™</h3>
            <div class="search-box">
                <input type="text" id="searchTaskInput" placeholder="è¼¸å…¥é—œéµå­—..." oninput="handleSearch()">
                <ul class="search-results" id="searchResults"></ul>
            </div>
        </div>

        <div class="sidebar-section">
            <h3>ğŸ“… æ—¥æœŸé¸æ“‡</h3>
            <input type="date" id="dateSearch" onchange="changeDate(this.value)">
        </div>
        <div class="sidebar-section" style="flex-grow: 1; display:flex; flex-direction:column; margin-top:20px;">
            <h3>ğŸ•’ æœ€è¿‘æª¢è¦–ç´€éŒ„</h3>
            <ul class="history-list" id="historyList"></ul>
        </div>
    </aside>
    <main>
        <header>
            <div class="date-header" id="headerDateDisplay"></div>
            <h1>æ¡ˆä»¶é€²åº¦ç®¡ç†</h1>
            <div class="overall-progress-container">
                <div class="progress-label">
                    <span>ç•¶æ—¥ç¸½å®Œæˆåº¦</span>
                    <span id="overallProgressText">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="overallProgressBar" style="width: 0%"></div>
                </div>
            </div>
        </header>
        <div class="task-container" id="taskListContainer"></div>
        <button class="fab" onclick="openModal()">+</button>
    </main>
</div>

<div class="modal-overlay" id="taskModal">
    <div class="modal-card">
        <h2 style="margin-top:0; color:#111827;" id="modalTitle">æ–°å¢æ¡ˆä»¶/ä»»å‹™</h2>
        
        <div class="input-group">
            <label>æ­¸å±¬é …ç›®</label>
            <select id="inputCategory" onchange="handleCategoryChange()">
                <option value="å®šåºæ”¶ä»¶">ğŸ“‚ å®šåºæ”¶ä»¶</option>
                <option value="å¼•å­é€ä»¶">ğŸš€ å¼•å­é€ä»¶</option>
                <option value="ç”¢å‰æ”¶ä»¶">ğŸ“¦ ç”¢å‰æ”¶ä»¶</option>
                <option value="æ¥­å‹™äº¤è¾¦äº‹é …">ğŸ“‹ æ¥­å‹™äº¤è¾¦äº‹é …</option>
                <option value="NGSæ”¶ä»¶">ğŸ§¬ NGS æ”¶ä»¶ (éœ€å¡«è©³ç´°è³‡æ–™)</option>
            </select>
        </div>

        <div id="ngs-form-container">
            <h4 style="margin-top:0; color:#0f766e;">ğŸ“ NGS è©³ç´°è³‡æ–™ (å¿…å¡«)</h4>
            <div class="ngs-row">
                <label>1. å–®ä½</label>
                <input type="text" id="ngsUnit" placeholder="è¼¸å…¥å–®ä½" oninput="generateNgsTitle()">
            </div>
            <div class="ngs-row">
                <label>2. ä¸»æŒäºº</label>
                <input type="text" id="ngsPI" placeholder="è¼¸å…¥ä¸»æŒäºº" oninput="generateNgsTitle()">
            </div>
            <div class="ngs-row">
                <label>3. æ¨£æœ¬è™•ç†éœ€æ±‚</label>
                <select id="ngsNeeds" onchange="handleNgsNeedsChange(); generateNgsTitle()">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="èƒå–">èƒå– (Extraction)</option>
                    <option value="QC">QC</option>
                </select>
            </div>
            
            <div id="ngs-extraction-fields">
                <div class="ngs-row">
                    <label>4-1.1 æª¢é«”ç¨®é¡</label>
                    <select id="ngsSampleTypeSelect" onchange="handleDropdownChange('ngsSampleTypeSelect', 'ngsSampleTypeInput')">
                        <option value="Cell">Cell</option>
                        <option value="Blood">Blood</option>
                        <option value="Tissue">Tissue</option>
                        <option value="Plant">Plant</option>
                        <option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option>
                    </select>
                    <input type="text" id="ngsSampleTypeInput" placeholder="è«‹è¼¸å…¥æª¢é«”ç¨®é¡" style="display:none; margin-top:5px;">
                </div>
                <div class="ngs-row">
                    <label>4-1.2 ä¿å­˜æº«åº¦</label>
                    <select id="ngsTemp">
                        <option value="å¸¸æº«">å¸¸æº«</option>
                        <option value="4Â°C">4Â°C</option>
                        <option value="-20Â°C">-20Â°C</option>
                        <option value="-80Â°C">-80Â°C</option>
                    </select>
                </div>
                <div class="ngs-row">
                    <label>4-1.3 æ­¸é‚„</label>
                    <select id="ngsReturn">
                        <option value="æ˜¯">æ˜¯</option>
                        <option value="å¦">å¦</option>
                    </select>
                </div>
                <div class="ngs-row">
                    <label>4-1.4 æ¨£æœ¬æ•¸é‡</label>
                    <input type="text" id="ngsCount" placeholder="å¡«å¯«æ•¸é‡">
                </div>
                <div class="ngs-row">
                    <label>4-1.5 å¾ŒçºŒå¯¦é©—ç¨®é¡</label>
                    <select id="ngsExpTypeSelect" onchange="handleDropdownChange('ngsExpTypeSelect', 'ngsExpTypeInput'); generateNgsTitle()">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="Seq Only">Seq Only</option>
                        <option value="DGE">DGE</option>
                        <option value="Small RNA">Small RNA</option>
                        <option value="WES">WES</option>
                        <option value="WGS">WGS</option>
                        <option value="PIPseq">PIPseq</option>
                        <option value="Amplicon Sequence">Amplicon Sequence</option>
                        <option value="ç´°èŒWGS">ç´°èŒWGS</option>
                        <option value="metagenome">metagenome</option>
                        <option value="16s">16s</option>
                        <option value="16sFL">16sFL</option>
                        <option value="Olink">Olink</option>
                        <option value="10x">10x</option>
                        <option value="RADseq">RADseq</option>
                        <option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option>
                    </select>
                    <input type="text" id="ngsExpTypeInput" placeholder="è¼¸å…¥ç¨®é¡" style="display:none; margin-top:5px;" oninput="generateNgsTitle()">
                </div>
                <div class="ngs-row">
                    <label>4-1.6 å¯¦é©—å¹³å°</label>
                    <select id="ngsPlatformSelect" onchange="handleDropdownChange('ngsPlatformSelect', 'ngsPlatformInput')">
                        <option value="Novaseq X Plus">Novaseq X Plus</option>
                        <option value="Miseq">Miseq</option>
                        <option value="PacBio">PacBio</option>
                        <option value="Nanopore">Nanopore</option>
                        <option value="Olink">Olink</option>
                        <option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option>
                    </select>
                    <input type="text" id="ngsPlatformInput" placeholder="è¼¸å…¥å¹³å°" style="display:none; margin-top:5px;">
                </div>
                <div class="ngs-row">
                    <label>4-1.7 è² è²¬æ¥­å‹™</label>
                    <select id="ngsSales"></select> </div>
            </div>

            <div id="ngs-qc-fields">
                <div class="ngs-row">
                    <label>4-2.1 æ ¸é…¸ç¨®é¡</label>
                    <select id="ngsNucleicTypeSelect" onchange="handleDropdownChange('ngsNucleicTypeSelect', 'ngsNucleicTypeInput'); generateNgsTitle()">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="DNA">DNA</option>
                        <option value="RNA">RNA</option>
                        <option value="Library">Library</option>
                        <option value="miRNA">miRNA</option>
                        <option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option>
                    </select>
                    <input type="text" id="ngsNucleicTypeInput" placeholder="è¼¸å…¥ç¨®é¡" style="display:none; margin-top:5px;" oninput="generateNgsTitle()">
                </div>
                <div class="ngs-row">
                    <label>4-2.2 ä¿å­˜æº«åº¦</label>
                    <select id="ngsQcTemp">
                        <option value="å¸¸æº«">å¸¸æº«</option>
                        <option value="4Â°C">4Â°C</option>
                        <option value="-20Â°C">-20Â°C</option>
                        <option value="-80Â°C">-80Â°C</option>
                    </select>
                </div>
                <div class="ngs-row">
                    <label>4-2.3 æ­¸é‚„</label>
                    <select id="ngsQcReturn">
                        <option value="æ˜¯">æ˜¯</option>
                        <option value="å¦">å¦</option>
                    </select>
                </div>
                <div class="ngs-row">
                    <label>4-2.4 æ¨£æœ¬æ•¸é‡</label>
                    <input type="text" id="ngsQcCount" placeholder="å¡«å¯«æ•¸é‡">
                </div>
                <div class="ngs-row">
                    <label>4-2.5 å¾ŒçºŒå¯¦é©—ç¨®é¡</label>
                    <select id="ngsQcExpTypeSelect" onchange="handleDropdownChange('ngsQcExpTypeSelect', 'ngsQcExpTypeInput')">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="Seq Only">Seq Only</option>
                        <option value="DGE">DGE</option>
                        <option value="Small RNA">Small RNA</option>
                        <option value="WES">WES</option>
                        <option value="WGS">WGS</option>
                        <option value="PIPseq">PIPseq</option>
                        <option value="Amplicon Sequence">Amplicon Sequence</option>
                        <option value="ç´°èŒWGS">ç´°èŒWGS</option>
                        <option value="metagenome">metagenome</option>
                        <option value="16s">16s</option>
                        <option value="16sFL">16sFL</option>
                        <option value="Olink">Olink</option>
                        <option value="10x">10x</option>
                        <option value="RADseq">RADseq</option>
                        <option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option>
                    </select>
                    <input type="text" id="ngsQcExpTypeInput" placeholder="è¼¸å…¥ç¨®é¡" style="display:none; margin-top:5px;">
                </div>
                <div class="ngs-row">
                    <label>4-2.6 å¯¦é©—å¹³å°</label>
                    <select id="ngsQcPlatformSelect" onchange="handleDropdownChange('ngsQcPlatformSelect', 'ngsQcPlatformInput')">
                        <option value="Novaseq X Plus">Novaseq X Plus</option>
                        <option value="Miseq">Miseq</option>
                        <option value="PacBio">PacBio</option>
                        <option value="Nanopore">Nanopore</option>
                        <option value="Olink">Olink</option>
                        <option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option>
                    </select>
                    <input type="text" id="ngsQcPlatformInput" placeholder="è¼¸å…¥å¹³å°" style="display:none; margin-top:5px;">
                </div>
                <div class="ngs-row">
                    <label>4-2.7 è² è²¬æ¥­å‹™</label>
                    <select id="ngsQcSales"></select> </div>
            </div>
        </div>

        <div class="input-group">
            <label>ä»»å‹™å…§å®¹ (é¸å–æ–‡å­—å¯ç·¨è¼¯æ¨£å¼)</label>
            <div class="editor-toolbar">
                <button class="tool-btn" onclick="formatDoc('bold')" title="ç²—é«”"><b>B</b></button>
                <div class="separator"></div>
                <button class="tool-btn" onclick="formatDoc('foreColor', '#ef4444')" title="ç´…å­—"><span class="color-dot" style="background:#ef4444"></span></button>
                <button class="tool-btn" onclick="formatDoc('foreColor', '#2563eb')" title="è—å­—"><span class="color-dot" style="background:#2563eb"></span></button>
                <button class="tool-btn" onclick="formatDoc('foreColor', '#10b981')" title="ç¶ å­—"><span class="color-dot" style="background:#10b981"></span></button>
                <button class="tool-btn" onclick="formatDoc('foreColor', '#000000')" title="é»‘å­—"><span class="color-dot" style="background:#000000"></span></button>
                <div class="separator"></div>
                <button class="tool-btn" onclick="formatDoc('hiliteColor', '#fecaca')" title="ç´…åº•" style="background:#fecaca">A</button>
                <button class="tool-btn" onclick="formatDoc('hiliteColor', '#bfdbfe')" title="è—åº•" style="background:#bfdbfe">A</button>
                <button class="tool-btn" onclick="formatDoc('hiliteColor', '#bbf7d0')" title="ç¶ åº•" style="background:#bbf7d0">A</button>
                <button class="tool-btn" onclick="formatDoc('hiliteColor', '#ffffff')" title="ç„¡åº•" style="background:#fff">âœ•</button>
                <div class="separator"></div>
                <select class="tool-select" onchange="formatDoc('fontSize', this.value); this.value='';" title="å­—é«”å¤§å°">
                    <option value="">å­—é«”å¤§å°</option>
                    <option value="2">å°</option>
                    <option value="3">ä¸­</option>
                    <option value="5">å¤§</option>
                    <option value="7">ç‰¹å¤§</option>
                </select>
            </div>
            <div id="inputTitle" contenteditable="true" placeholder="è¼¸å…¥å…§å®¹..."></div>
        </div>
        
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" id="btnSaveTask" onclick="saveTask()">ç¢ºèª</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="salesSettingsModal">
    <div class="modal-card" style="width: 450px;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">âš™ï¸ NGS è² è²¬æ¥­å‹™è¨­å®š</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="newSalesName" placeholder="è¼¸å…¥æ–°æ¥­å‹™å§“å" style="flex-grow:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
            <button class="btn btn-save" onclick="addSalesOption()">æ–°å¢</button>
        </div>
        <ul class="settings-list" id="salesOptionList">
            </ul>
        <div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('salesSettingsModal').style.display='none'">é—œé–‰</button></div>
    </div>
</div>

<div class="modal-overlay" id="historyModal">
    <div class="modal-card" style="width: 400px;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“‹ ç·¨è¼¯/æ“ä½œç´€éŒ„</h3>
        <ul class="log-list" id="logList"></ul>
        <div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('historyModal').style.display='none'">é—œé–‰</button></div>
    </div>
</div>

<div class="modal-overlay" id="userModal">
    <div class="modal-card" style="width: 650px;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ‘¥ æˆå“¡æ¬Šé™ç®¡ç†</h3>
        <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">
            <span style="color:#7e22ce; font-weight:bold;">ğŸŸ£ å‰µä¸–ç¥</span>ï¼šæœ€é«˜æ¬Šé™ï¼Œä¸å¯è¢«ä¿®æ”¹ã€‚<br>
            é«˜ç´šç®¡ç†è€…å¯ç·¨è¼¯è³‡æ–™ï¼›ç®¡ç†è€…åƒ…èƒ½æ ¸å‡†ã€‚
        </p>
        <ul class="user-list" id="userListDisplay"></ul>
        <div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('userModal').style.display='none'">é—œé–‰</button></div>
    </div>
</div>

<div class="modal-overlay" id="statsModal">
    <div class="modal-card" style="width: 700px;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“Š ä»»å‹™å®Œæˆçµ±æ•´</h3>
        <div class="stats-filter-row">
            <div><label style="font-size:0.8rem;">é–‹å§‹æ—¥æœŸ</label><input type="date" id="statsDateStart"></div>
            <div><label style="font-size:0.8rem;">çµæŸæ—¥æœŸ</label><input type="date" id="statsDateEnd"></div>
            <div><label style="font-size:0.8rem;">æª¢ç´¢å¸³è™Ÿ</label><select id="statsUserSelect"><option value="all">-- æ‰€æœ‰å¸³è™Ÿ (ç¸½è¦½) --</option></select></div>
            <div style="display:flex; align-items:flex-end;"><button class="btn btn-save" onclick="updateStats()">æŸ¥è©¢</button></div>
        </div>
        <div class="stats-result-area" id="statsResultDisplay"></div>
        <div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('statsModal').style.display='none'">é—œé–‰</button></div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyBPcmgaT4f3nfyJrJOXnAeYCwH19SwZvCA",
      authDomain: "tasktrack-app-206f8.firebaseapp.com",
      projectId: "tasktrack-app-206f8",
      storageBucket: "tasktrack-app-206f8.firebasestorage.app",
      messagingSenderId: "528459789330",
      appId: "1:528459789330:web:caca16ee7c2b4efa1754cb",
      measurementId: "G-7JHGQW385H"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ORDERED_CATEGORIES = ["å®šåºæ”¶ä»¶", "å¼•å­é€ä»¶", "ç”¢å‰æ”¶ä»¶", "æ¥­å‹™äº¤è¾¦äº‹é …", "NGSæ”¶ä»¶"];
    let state = {
        currentUser: null, currentDate: getTodayStr(),
        tasks: [], users: [], salesOptions: [], history: JSON.parse(localStorage.getItem('tt_history')||'[]'), editingTaskId: null
    };

    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function formatDoc(cmd, value) { document.execCommand(cmd, false, value); document.getElementById('inputTitle').focus(); }

    /* --- MOBILE MENU --- */
    function toggleSidebar() {
        document.querySelector('aside').classList.toggle('open');
        document.getElementById('sidebar-overlay').classList.toggle('active');
    }

    /* --- REAL-TIME LISTENERS --- */
    db.collection('tasks').onSnapshot(snapshot => {
        state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTasks();
    });
    db.collection('users').onSnapshot(snapshot => {
        state.users = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
        if(document.getElementById('userModal').style.display === 'flex') openUserModal();
        
        // FORCE LOGOUT
        if (state.currentUser) {
            const me = state.users.find(u => u.username === state.currentUser.name);
            if (!me) {
                alert('æ‚¨çš„å¸³è™Ÿå·²è¢«ç§»é™¤ï¼Œå³å°‡å¼·åˆ¶ç™»å‡ºã€‚');
                logout();
            } else if (state.currentUser.role !== me.role) {
                state.currentUser.role = me.role;
                localStorage.setItem('tt_current_user', JSON.stringify(state.currentUser));
                updateUIForRole();
            }
        }
    });
    
    // Listen for Settings
    db.collection('settings').doc('ngs_sales').onSnapshot(doc => {
        if(doc.exists) {
            state.salesOptions = doc.data().list || ['Jeff', 'å»–è»’é€µ'];
        } else {
            // Init default if not exists
            state.salesOptions = ['Jeff', 'å»–è»’é€µ'];
            db.collection('settings').doc('ngs_sales').set({ list: state.salesOptions });
        }
        if(document.getElementById('salesSettingsModal').style.display === 'flex') openSalesSettings();
    });

    /* --- Auth Logic (Unified) --- */
    function toggleAuthMode() {
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('btnAuthAction');
        const link = document.getElementById('switchAuthLink');
        if (title.innerText.includes('ç™»å…¥')) {
            title.innerText = 'è¨»å†Šæ–°å¸³è™Ÿ'; btn.innerText = 'è¨»å†Š'; link.innerText = 'å·²æœ‰å¸³è™Ÿï¼Ÿç™»å…¥';
        } else {
            title.innerText = 'ç³»çµ±ç™»å…¥'; btn.innerText = 'ç™»å…¥'; link.innerText = 'æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Šæ–°å¸³è™Ÿ';
        }
    }

    async function handleAuth() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        const title = document.getElementById('auth-title').innerText;
        const btn = document.getElementById('btnAuthAction');

        if(!u || !p) return alert('è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼');
        btn.disabled = true;

        try {
            if (title.includes('è¨»å†Š')) {
                // Register
                if (u.toLowerCase() === 'admin') throw new Error('ä¸å¯ä½¿ç”¨ Admin ä½œç‚ºå¸³è™Ÿ');
                const q = await db.collection('users').where('username', '==', u).get();
                if (!q.empty) throw new Error('å¸³è™Ÿå·²å­˜åœ¨');
                
                await db.collection('users').add({ username: u, password: p, isApproved: false, role: 'user', remarks: '' });
                alert('è¨»å†ŠæˆåŠŸï¼å¾…ç®¡ç†å“¡æ ¸å‡†å¾Œæ–¹å¯ç™»å…¥ã€‚');
                toggleAuthMode();
            } else {
                // Login
                if (u === 'Admin' && p === 'Abcd1234') {
                    // Admin Backdoor / Auto-heal
                    const q = await db.collection('users').where('username', '==', 'Admin').get();
                    if(q.empty) {
                        await db.collection('users').add({ username: 'Admin', password: p, isApproved: true, role: 'creator', remarks: 'å‰µä¸–ç¥' });
                    } else {
                        // Ensure role is creator
                        const docId = q.docs[0].id;
                        if(q.docs[0].data().role !== 'creator') await db.collection('users').doc(docId).update({ role: 'creator' });
                    }
                    loginSuccess('Admin', 'creator');
                } else {
                    // Regular Login
                    const q = await db.collection('users').where('username', '==', u).where('password', '==', p).get();
                    if (q.empty) {
                        alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
                    } else {
                        const user = q.docs[0].data();
                        if (!user.isApproved) {
                            alert('âš ï¸ æ‚¨çš„å¸³è™Ÿå°šæœªé€šéå¯©æ ¸ã€‚');
                        } else {
                            loginSuccess(user.username, user.role || 'user');
                        }
                    }
                }
            }
        } catch (e) {
            alert(e.message || 'ç™¼ç”ŸéŒ¯èª¤');
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }

    function loginSuccess(username, role) {
        state.currentUser = { name: username, role: role };
        localStorage.setItem('tt_current_user', JSON.stringify(state.currentUser));
        initApp();
    }
    function logout() { localStorage.removeItem('tt_current_user'); location.reload(); }
    
    function initApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';
        updateUIForRole();
        changeDate(state.currentDate, false);
    }

    function updateUIForRole() {
        if(!state.currentUser) return;
        let roleName = '';
        if(state.currentUser.role === 'creator') roleName = ' (å‰µä¸–ç¥)';
        else if(state.currentUser.role === 'senior') roleName = ' (é«˜ç´šç®¡ç†è€…)';
        else if(state.currentUser.role === 'admin') roleName = ' (ç®¡ç†è€…)';
        
        document.getElementById('displayUsername').innerText = state.currentUser.name + roleName;
        document.getElementById('userAvatar').innerText = state.currentUser.name[0].toUpperCase();
        
        const canManage = ['creator','senior','admin'].includes(state.currentUser.role);
        const canConfig = ['creator','senior'].includes(state.currentUser.role);
        
        document.getElementById('adminPanelBtn').style.display = canManage ? 'block' : 'none';
        document.getElementById('statsPanelBtn').style.display = canConfig ? 'block' : 'none';
        document.getElementById('salesSettingsBtn').style.display = canConfig ? 'block' : 'none';
    }

    /* --- SALES SETTINGS --- */
    function openSalesSettings() {
        const list = document.getElementById('salesOptionList');
        list.innerHTML = '';
        state.salesOptions.forEach((opt, index) => {
            const li = document.createElement('li');
            li.className = 'setting-item';
            li.innerHTML = `
                <span>${opt}</span>
                <div>
                    <button class="btn-icon" onclick="editSalesOption(${index})">âœï¸</button>
                    <button class="btn-icon" style="color:red;" onclick="deleteSalesOption(${index})">ğŸ—‘ï¸</button>
                </div>
            `;
            list.appendChild(li);
        });
        document.getElementById('salesSettingsModal').style.display = 'flex';
    }

    function saveSalesSettings() {
        db.collection('settings').doc('ngs_sales').update({ list: state.salesOptions });
    }

    function addSalesOption() {
        const input = document.getElementById('newSalesName');
        const val = input.value.trim();
        if(val) {
            state.salesOptions.push(val);
            saveSalesSettings();
            input.value = '';
        }
    }

    function deleteSalesOption(index) {
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤æ¥­å‹™é¸é …ï¼Ÿ')) {
            state.salesOptions.splice(index, 1);
            saveSalesSettings();
        }
    }

    function editSalesOption(index) {
        const newVal = prompt("ä¿®æ”¹æ¥­å‹™å§“å:", state.salesOptions[index]);
        if(newVal && newVal.trim() !== "") {
            state.salesOptions[index] = newVal.trim();
            saveSalesSettings();
        }
    }

    function populateSalesDropdowns() {
        const optsHtml = state.salesOptions.map(s => `<option value="${s}">${s}</option>`).join('');
        const s1 = document.getElementById('ngsSales');
        const s2 = document.getElementById('ngsQcSales');
        if(s1) s1.innerHTML = optsHtml;
        if(s2) s2.innerHTML = optsHtml;
    }

    /* --- SEARCH --- */
    function handleSearch() {
        const keyword = document.getElementById('searchTaskInput').value.trim().toLowerCase();
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';
        if (!keyword) return;

        const matched = state.tasks.filter(t => t.title.replace(/<[^>]*>/g, '').toLowerCase().includes(keyword));
        matched.slice(0, 20).forEach(t => {
            const li = document.createElement('li'); li.className = 'search-item';
            const rawTitle = t.title.replace(/<[^>]*>/g, '');
            li.innerHTML = `<span>${rawTitle}</span><span class="search-date">${t.date}</span>`;
            li.onclick = () => { changeDate(t.date); if(window.innerWidth<=768) toggleSidebar(); };
            resultsContainer.appendChild(li);
        });
        if(matched.length === 0) resultsContainer.innerHTML = '<li class="search-item" style="color:#999; cursor:default;">ç„¡ç›¸ç¬¦çµæœ</li>';
    }

    /* --- NGS FORM LOGIC --- */
    function handleCategoryChange() {
        const cat = document.getElementById('inputCategory').value;
        const ngsForm = document.getElementById('ngs-form-container');
        if (cat === 'NGSæ”¶ä»¶') {
            ngsForm.style.display = 'block';
        } else {
            ngsForm.style.display = 'none';
        }
    }

    function handleNgsNeedsChange() {
        const needs = document.getElementById('ngsNeeds').value;
        const exFields = document.getElementById('ngs-extraction-fields');
        const qcFields = document.getElementById('ngs-qc-fields');
        
        exFields.style.display = (needs === 'èƒå–') ? 'block' : 'none';
        qcFields.style.display = (needs === 'QC') ? 'block' : 'none';
    }

    function handleDropdownChange(selectId, inputId) {
        const val = document.getElementById(selectId).value;
        document.getElementById(inputId).style.display = (val === 'å…¶ä»–') ? 'block' : 'none';
    }

    function generateNgsTitle() {
        const cat = document.getElementById('inputCategory').value;
        if (cat !== 'NGSæ”¶ä»¶') return;

        const unit = document.getElementById('ngsUnit').value.trim();
        const pi = document.getElementById('ngsPI').value.trim();
        const needs = document.getElementById('ngsNeeds').value;
        
        let subType = '';
        
        if (needs === 'èƒå–') {
            const sel = document.getElementById('ngsExpTypeSelect').value;
            subType = (sel === 'å…¶ä»–') ? document.getElementById('ngsExpTypeInput').value.trim() : sel;
        } else if (needs === 'QC') {
            const sel = document.getElementById('ngsNucleicTypeSelect').value;
            subType = (sel === 'å…¶ä»–') ? document.getElementById('ngsNucleicTypeInput').value.trim() : sel;
        }

        if (unit && pi && subType) {
            document.getElementById('inputTitle').innerText = `${unit}-${pi}-${subType} æ”¶ä»¶`;
        }
    }

    /* --- STATS --- */
    function openStatsModal() {
        const modal = document.getElementById('statsModal');
        const userSelect = document.getElementById('statsUserSelect');
        const startInput = document.getElementById('statsDateStart');
        const endInput = document.getElementById('statsDateEnd');

        userSelect.innerHTML = '<option value="all">-- æ‰€æœ‰å¸³è™Ÿ (ç¸½è¦½) --</option>';
        const uniqueUsers = [...new Set(state.tasks.filter(t=>t.completed && t.completedBy).map(t=>t.completedBy))];
        uniqueUsers.sort().forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.innerText = u; userSelect.appendChild(opt); });

        const year = new Date().getFullYear();
        startInput.value = `${year}-01-01`; endInput.value = `${year}-12-31`;
        updateStats(); modal.style.display = 'flex';
    }

    function updateStats() {
        const start = document.getElementById('statsDateStart').value;
        const end = document.getElementById('statsDateEnd').value;
        const selectedUser = document.getElementById('statsUserSelect').value;
        const display = document.getElementById('statsResultDisplay');
        display.innerHTML = '';
        if(!start || !end) return;

        const validTasks = state.tasks.filter(t => {
            if(!t.completed || t.isDeleted || !t.completedBy) return false;
            return t.date >= start && t.date <= end;
        });

        if (selectedUser === 'all') {
            const userCounts = {}; let total = 0;
            validTasks.forEach(t => { if(!userCounts[t.completedBy]) userCounts[t.completedBy]=0; userCounts[t.completedBy]++; total++; });
            if(total === 0) { display.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æ­¤å€é–“ç„¡å®Œæˆè³‡æ–™</div>'; return; }
            Object.entries(userCounts).sort((a,b)=>b[1]-a[1]).forEach(([user, count]) => {
                const pct = Math.round((count/total)*100);
                const card = document.createElement('div'); card.className = 'stat-card';
                card.innerHTML = `<div class="stat-header"><span>${user}</span> <span>${count} ä»¶</span></div><div class="stat-bar-container"><div class="stat-label"><span>ä½”æ¯”</span><span>${pct}%</span></div><div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div></div>`;
                display.appendChild(card);
            });
        } else {
            const userTasks = validTasks.filter(t => t.completedBy === selectedUser);
            const total = userTasks.length;
            if(total === 0) { display.innerHTML = `<div style="text-align:center; padding:20px; color:#888;">å¸³è™Ÿ ${selectedUser} åœ¨æ­¤å€é–“ç„¡å®Œæˆè³‡æ–™</div>`; return; }
            const catCounts = {}; ORDERED_CATEGORIES.forEach(c => catCounts[c]=0);
            userTasks.forEach(t => { if(catCounts[t.category]!==undefined) catCounts[t.category]++; });
            
            const card = document.createElement('div'); card.className = 'stat-card';
            card.innerHTML = `<div class="stat-header" style="border-bottom:1px solid #eee; padding-bottom:5px;">${selectedUser} - ç¸½è¨ˆ ${total} ä»¶</div>`;
            ORDERED_CATEGORIES.forEach(cat => {
                const count = catCounts[cat]; const pct = total===0?0:Math.round((count/total)*100);
                card.innerHTML += `<div style="margin-top:10px;"><div class="stat-label"><span>${cat}</span><span>${count} (${pct}%)</span></div><div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div></div>`;
            });
            display.appendChild(card);
        }
    }

    /* --- USER MANAGEMENT --- */
    function openUserModal() {
        const list = document.getElementById('userListDisplay');
        const myRole = state.currentUser.role;
        list.innerHTML = '';
        if (state.users.length === 0) list.innerHTML = '<li style="padding:10px; color:#666;">ç›®å‰ç„¡ä¸€èˆ¬ä½¿ç”¨è€…å¸³è™Ÿã€‚</li>';

        state.users.forEach(user => {
            const li = document.createElement('li'); li.className = 'user-item';
            const isApproved = user.isApproved;
            
            let badgeClass = 'role-user'; let badgeText = 'ä¸€èˆ¬è€…';
            if(user.role === 'creator') { badgeClass = 'role-creator'; badgeText = 'ğŸŸ£ å‰µä¸–ç¥'; }
            else if(user.role === 'senior') { badgeClass = 'role-senior'; badgeText = 'é«˜ç´šç®¡ç†è€…'; }
            else if(user.role === 'admin') { badgeClass = 'role-admin'; badgeText = 'ç®¡ç†è€…'; }
            if(!isApproved) { badgeClass = ''; badgeText = 'å¾…å¯©æ ¸'; }

            const isTargetCreator = user.role === 'creator';
            let controlsHtml = '';

            if (myRole === 'creator') {
                const selUser = user.role === 'user' ? 'selected' : '';
                const selAdmin = user.role === 'admin' ? 'selected' : '';
                const selSenior = user.role === 'senior' ? 'selected' : '';
                
                const pwdId = `pwd_${user.docId}`;
                const roleSelect = isTargetCreator ? `<select disabled><option selected>å‰µä¸–ç¥</option></select>` : 
                    `<select id="role_${user.docId}"><option value="user" ${selUser}>ä¸€èˆ¬è€…</option><option value="admin" ${selAdmin}>ç®¡ç†è€…</option><option value="senior" ${selSenior}>é«˜ç´šç®¡ç†è€…</option></select>`;

                controlsHtml = `
                    <div class="user-edit-row">${roleSelect}<input type="text" id="note_${user.docId}" placeholder="å‚™è¨»" value="${user.remarks || ''}"></div>
                    <div class="user-edit-row"><span class="readonly-text" style="min-width:60px;">å¯†ç¢¼:</span><input type="password" id="${pwdId}" value="${user.password}" readonly style="background:#eee; color:#555;"><button class="btn-icon-eye" onclick="togglePasswordVisibility('${pwdId}')" title="é¡¯ç¤º/éš±è—å¯†ç¢¼">ğŸ‘ï¸</button></div>
                    <div style="text-align:right;"><button class="btn-approve" onclick="updateUser('${user.docId}')">${isApproved?'æ›´æ–°è³‡æ–™':'æ ¸å‡†/æ›´æ–°'}</button>${ !isTargetCreator ? `<button class="btn-reject" onclick="deleteUser('${user.docId}')">åˆªé™¤</button>` : '' }</div>`;
            } 
            else if (myRole === 'senior') {
                if (isTargetCreator) {
                    controlsHtml = `<div class="user-edit-row"><span style="color:purple; font-weight:bold;">æ­¤ç‚ºæœ€é«˜æ¬Šé™å¸³è™Ÿï¼Œç„¡æ³•ç·¨è¼¯ã€‚</span></div>`;
                } else {
                    const selUser = user.role === 'user' ? 'selected' : '';
                    const selAdmin = user.role === 'admin' ? 'selected' : '';
                    const selSenior = user.role === 'senior' ? 'selected' : '';
                    const pwdId = `pwd_${user.docId}`;
                    controlsHtml = `<div class="user-edit-row"><select id="role_${user.docId}"><option value="user" ${selUser}>ä¸€èˆ¬è€…</option><option value="admin" ${selAdmin}>ç®¡ç†è€…</option><option value="senior" ${selSenior}>é«˜ç´šç®¡ç†è€…</option></select><input type="text" id="note_${user.docId}" placeholder="å‚™è¨»" value="${user.remarks || ''}"></div><div class="user-edit-row"><span class="readonly-text" style="min-width:60px;">å¯†ç¢¼:</span><input type="password" id="${pwdId}" value="${user.password}" readonly style="background:#eee; color:#555;"><button class="btn-icon-eye" onclick="togglePasswordVisibility('${pwdId}')" title="é¡¯ç¤º/éš±è—å¯†ç¢¼">ğŸ‘ï¸</button></div><div style="text-align:right;"><button class="btn-approve" onclick="updateUser('${user.docId}')">${isApproved?'æ›´æ–°è³‡æ–™':'æ ¸å‡†/æ›´æ–°'}</button><button class="btn-reject" onclick="deleteUser('${user.docId}')">åˆªé™¤</button></div>`;
                }
            }
            else if (myRole === 'admin') {
                if (isTargetCreator || user.role === 'senior') {
                    controlsHtml = `<div class="user-edit-row"><span class="readonly-text">æ¬Šé™é«˜æ–¼æˆ–ç­‰æ–¼æ‚¨ï¼Œç„¡æ³•æª¢è¦–è©³ç´°è³‡æ–™ã€‚</span></div>`;
                } else {
                    let actionBtn = !isApproved ? `<button class="btn-approve" onclick="approveUserSimple('${user.docId}')">æ ¸å‡†ç”³è«‹</button>` : `<span style="color:#10b981; font-size:0.85rem;">å·²æ ¸å‡†</span>`;
                    controlsHtml = `<div class="user-edit-row"><span class="readonly-text">è§’è‰²: ${badgeText}</span><span class="readonly-text" style="margin-left:15px;">å‚™è¨»: ${user.remarks || '(ç„¡)'}</span></div><div style="text-align:right;">${actionBtn}</div>`;
                }
            }

            li.innerHTML = `<div class="user-header"><div><span class="user-name">${user.username}</span><span class="user-role-badge ${badgeClass}">${badgeText}</span></div></div>${controlsHtml}`;
            list.appendChild(li);
        });
        document.getElementById('userModal').style.display = 'flex';
    }

    function togglePasswordVisibility(id) {
        const input = document.getElementById(id);
        if (input.type === "password") { input.type = "text"; } else { input.type = "password"; }
    }

    function updateUser(docId) {
        const role = document.getElementById(`role_${docId}`).value;
        const note = document.getElementById(`note_${docId}`).value;
        db.collection('users').doc(docId).update({ role: role, remarks: note, isApproved: true }).then(() => alert('è³‡æ–™å·²æ›´æ–°'));
    }
    function deleteUser(docId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¸³è™Ÿå—ï¼Ÿ')) return;
        db.collection('users').doc(docId).delete().then(() => openUserModal());
    }
    function approveUserSimple(docId) {
        db.collection('users').doc(docId).update({ isApproved: true }).then(() => alert('å·²æ ¸å‡†å¸³è™Ÿ'));
    }

    /* --- TASKS CRUD --- */
    function renderTasks() {
        const container = document.getElementById('taskListContainer');
        container.innerHTML = '';
        
        // Overdue
        const overdueTasks = state.tasks.filter(t => t.date < state.currentDate && !t.completed && !t.isDeleted);
        if (overdueTasks.length > 0) {
            const group = document.createElement('div'); group.className = 'category-group overdue-section';
            group.innerHTML = `<div class="category-header-row"><div class="cat-title">ğŸš¨ å…ˆå‰æœªå®Œæˆ <span class="badge-count" style="background:#fee2e2; color:#b91c1c;">${overdueTasks.length}</span></div></div>`;
            overdueTasks.sort((a,b)=>new Date(a.date)-new Date(b.date));
            overdueTasks.forEach(t => group.appendChild(createTaskElement(t, true)));
            container.appendChild(group);
        }

        const dayTasks = state.tasks.filter(t => t.date === state.currentDate);
        const totalActive = dayTasks.filter(t => !t.isDeleted).length;
        const totalDone = dayTasks.filter(t => !t.isDeleted && t.completed).length;
        const totalPct = totalActive===0?0:Math.round((totalDone/totalActive)*100);
        document.getElementById('overallProgressText').innerText = `${totalDone}/${totalActive} (${totalPct}%)`;
        document.getElementById('overallProgressBar').style.width = `${totalPct}%`;

        if (dayTasks.length === 0 && overdueTasks.length === 0) {
            container.innerHTML += `<div style="text-align:center; color:#9ca3b8; margin-top:60px;">æœ¬æ—¥ç„¡ä»»ä½•æ¡ˆä»¶æˆ–ä»»å‹™</div>`; return;
        }

        ORDERED_CATEGORIES.forEach(cat => {
            const all = dayTasks.filter(t => t.category === cat && !t.isDeleted);
            const active = all.filter(t => !t.completed);
            const pct = all.length===0?0:Math.round((all.filter(t=>t.completed).length/all.length)*100);
            const group = document.createElement('div'); group.className = 'category-group';
            group.innerHTML = `<div class="category-header-row"><div class="cat-title">${cat} <span class="badge-count">${active.length}</span></div><div style="font-size:0.8rem; color:#6b7280; font-weight:600;">${pct}%</div></div><div class="cat-progress-track"><div class="cat-progress-fill" style="width: ${pct}%"></div></div>`;
            if (active.length > 0) active.forEach(t => group.appendChild(createTaskElement(t)));
            else group.innerHTML += `<div style="font-size:0.9rem; color:#d1d5db; padding-left:10px; margin-bottom:10px;">ç„¡å¾…è¾¦äº‹é …</div>`;
            container.appendChild(group);
        });

        const completed = dayTasks.filter(t => t.completed && !t.isDeleted);
        if (completed.length > 0) {
            const group = document.createElement('div'); group.className = 'category-group completed-section';
            group.innerHTML = `<div class="category-header-row"><div class="cat-title">âœ… å·²å®Œæˆ <span class="badge-count">${completed.length}</span></div></div>`;
            completed.sort((a,b)=>new Date(a.completedAt)-new Date(b.completedAt));
            completed.forEach(t => group.appendChild(createTaskElement(t)));
            container.appendChild(group);
        }
        const deleted = dayTasks.filter(t => t.isDeleted);
        if (deleted.length > 0) {
            const group = document.createElement('div'); group.className = 'category-group deleted-section';
            group.innerHTML = `<div class="category-header-row"><div class="cat-title">ğŸ—‘ï¸ è¢«åˆªé™¤é …ç›® <span class="badge-count">${deleted.length}</span></div></div>`;
            deleted.forEach(t => group.appendChild(createTaskElement(t)));
            container.appendChild(group);
        }
    }

    function createTaskElement(task, isOverdue = false) {
        const div = document.createElement('div');
        const overdueClass = isOverdue ? 'overdue-item' : '';
        div.className = `task-item ${overdueClass} ${task.completed ? 'completed-item' : ''} ${task.isDeleted ? 'deleted-item' : ''}`;
        div.setAttribute('data-cat', task.category);
        
        let checkboxHtml = task.isDeleted ? '' : `<div class="task-checkbox" onclick="toggleTask('${task.id}')"></div>`;
        let metaHtml = '';
        if (task.completed && !task.isDeleted) {
            const d = new Date(task.completedAt);
            metaHtml = `<div class="task-meta">åŸå§‹åˆ†é¡: ${task.category}<br><span class="completed-info">${task.completedBy} æ–¼ ${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')} å®Œæˆ</span></div>`;
        } else if (isOverdue) {
            metaHtml = `<div class="task-meta"><span class="task-overdue-date">å»ºç«‹æ–¼: ${task.date}</span></div>`;
        }

        // Show NGS Details if available
        let ngsInfoHtml = '';
        if (task.details) {
            ngsInfoHtml += `<div style="margin-top:5px; padding:5px; background:#f0fdfa; border-radius:4px; font-size:0.8rem; color:#0f766e;">
                <div><span class="ngs-badge">å–®ä½</span> ${task.details.unit}</div>
                <div><span class="ngs-badge">ä¸»æŒäºº</span> ${task.details.pi}</div>
                <div><span class="ngs-badge">éœ€æ±‚</span> ${task.details.needs}</div>`;
            
            if(task.details.needs === 'èƒå–') {
                ngsInfoHtml += `<div><span class="ngs-badge">ç¨®é¡</span> ${task.details.sampleType} | æ•¸é‡:${task.details.sampleCount}</div>
                <div><span class="ngs-badge">å¾ŒçºŒ</span> ${task.details.expType} | å¹³å°:${task.details.platform}</div>
                <div><span class="ngs-badge">æ¥­å‹™</span> ${task.details.sales} | æ­¸é‚„:${task.details.returnBack} | ${task.details.temp}</div>`;
            } else if (task.details.needs === 'QC') {
                ngsInfoHtml += `<div><span class="ngs-badge">æ ¸é…¸</span> ${task.details.nucleicType} | æ•¸é‡:${task.details.sampleCount}</div>
                <div><span class="ngs-badge">å¾ŒçºŒ</span> ${task.details.expType} | å¹³å°:${task.details.platform}</div>
                <div><span class="ngs-badge">æ¥­å‹™</span> ${task.details.sales} | æ­¸é‚„:${task.details.returnBack} | ${task.details.temp}</div>`;
            }
            ngsInfoHtml += `</div>`;
        }
        
        let actionBtn = task.isDeleted 
            ? `<button class="btn-icon btn-restore" onclick="restoreTask('${task.id}')">â†© é‚„åŸ</button>`
            : `<button class="btn-icon btn-delete" onclick="deleteTask('${task.id}')">Ã—</button>`;
            
        // LINE BUTTON (Only for Admin+)
        let lineBtnHtml = '';
        const canNotify = ['creator', 'senior', 'admin'].includes(state.currentUser.role);
        if (canNotify && !task.isDeleted) {
            let lineText = '';
            if (task.category === 'NGSæ”¶ä»¶' && task.details) {
                lineText = `ã€NGSæ¡ˆä»¶é€šçŸ¥ã€‘\nå–®ä½: ${task.details.unit}\nä¸»æŒäºº: ${task.details.pi}\né …ç›®: ${task.details.needs === 'èƒå–' ? task.details.expType : task.details.nucleicType}\nè² è²¬æ¥­å‹™: ${task.details.sales}`;
            } else {
                const plainTitle = task.title.replace(/<[^>]*>/g, '');
                lineText = `ã€ä»»å‹™é€šçŸ¥ã€‘\n${plainTitle}`;
            }
            const encodedText = encodeURIComponent(lineText);
            lineBtnHtml = `<a href="https://line.me/R/share?text=${encodedText}" target="_blank" class="btn-icon btn-line" style="text-decoration:none;" title="LINEé€šçŸ¥">ğŸ’¬</a>`;
        }

        const clickEvent = (!task.isDeleted) ? `onclick="openModal('${task.id}')"` : '';
        div.innerHTML = `${checkboxHtml}<div class="task-content"><div class="task-title" ${clickEvent}>${task.title}</div>${ngsInfoHtml}${metaHtml}</div><div class="action-area">${lineBtnHtml}<div class="history-dot" onclick="showHistory('${task.id}')">â‹®</div>${actionBtn}</div>`;
        return div;
    }

    /* --- DB OPERATIONS --- */
    function toggleTask(id) {
        const task = state.tasks.find(t => t.id === id);
        if(task) {
            const newVal = !task.completed;
            const updateData = { completed: newVal, completedBy: newVal ? state.currentUser.name : null, completedAt: newVal ? new Date().toISOString() : null };
            updateTaskDb(id, updateData, newVal ? 'å®Œæˆ' : 'é‡å•Ÿ', newVal ? 'æ¨™è¨˜ç‚ºå®Œæˆ' : 'å–æ¶ˆå®Œæˆç‹€æ…‹');
        }
    }
    
    function getDropdownOrInput(selectId, inputId) {
        const sel = document.getElementById(selectId).value;
        return (sel === 'å…¶ä»–') ? document.getElementById(inputId).value.trim() : sel;
    }

    function saveTask() {
        const htmlContent = document.getElementById('inputTitle').innerHTML.trim();
        const category = document.getElementById('inputCategory').value;
        const textContent = document.getElementById('inputTitle').innerText.trim();
        
        // VALIDATION
        if(textContent === '' && !htmlContent.includes('<img')) return alert('è«‹è¼¸å…¥ä»»å‹™å…§å®¹');
        
        // NGS Specific Validation & Data Collection
        let details = null;
        if (category === 'NGSæ”¶ä»¶') {
            const unit = document.getElementById('ngsUnit').value.trim();
            const pi = document.getElementById('ngsPI').value.trim();
            const needs = document.getElementById('ngsNeeds').value;
            
            if (!unit || !pi || !needs) return alert('è«‹å®Œæ•´å¡«å¯« NGS è©³ç´°è³‡æ–™');
            
            details = { unit, pi, needs };
            
            // Common fields for Extraction AND QC (based on prompt v22 update)
            if (needs === 'èƒå–' || needs === 'QC') {
                const prefix = needs === 'èƒå–' ? 'ngs' : 'ngsQc';
                
                // Specific Type field
                if (needs === 'èƒå–') {
                    details.sampleType = getDropdownOrInput('ngsSampleTypeSelect', 'ngsSampleTypeInput');
                    if (!details.sampleType) return alert('è«‹å¡«å¯«æª¢é«”ç¨®é¡');
                } else {
                    details.nucleicType = getDropdownOrInput('ngsNucleicTypeSelect', 'ngsNucleicTypeInput');
                    if (!details.nucleicType) return alert('è«‹å¡«å¯«æ ¸é…¸ç¨®é¡');
                }

                // Shared fields (Logic mapped to correct IDs)
                details.temp = document.getElementById(prefix + 'Temp').value;
                details.returnBack = document.getElementById(prefix + 'Return').value;
                details.sampleCount = document.getElementById(prefix + 'Count').value.trim();
                details.expType = getDropdownOrInput(prefix + 'ExpTypeSelect', prefix + 'ExpTypeInput');
                details.platform = getDropdownOrInput(prefix + 'PlatformSelect', prefix + 'PlatformInput');
                details.sales = document.getElementById(prefix + 'Sales').value;

                if (!details.sampleCount || !details.expType || !details.platform) return alert('è«‹å®Œæ•´å¡«å¯«è©³ç´°è³‡æ–™ (æ•¸é‡ã€å¯¦é©—ã€å¹³å°)');
            }
        }

        if(state.editingTaskId) {
            updateTaskDb(state.editingTaskId, { title: htmlContent, category: category, details: details }, 'ä¿®æ”¹', 'ç·¨è¼¯ä»»å‹™å…§å®¹/åˆ†é¡');
        } else {
            const newTask = { title: htmlContent, category: category, date: state.currentDate, completed: false, isDeleted: false, logs: [], createdAt: new Date().toISOString(), details: details };
            newTask.logs.push({ type: 'å»ºç«‹', desc: `å»ºç«‹ä»»å‹™æ–¼ [${category}]`, user: state.currentUser.name, time: new Date().toISOString() });
            db.collection('tasks').add(newTask);
        }
        closeModal();
    }
    function deleteTask(id) { if(confirm('ç§»è‡³è¢«åˆªé™¤é …ç›®ï¼Ÿ')) updateTaskDb(id, { isDeleted: true }, 'åˆªé™¤', 'ç§»è‡³è¢«åˆªé™¤é …ç›®'); }
    function restoreTask(id) { updateTaskDb(id, { isDeleted: false }, 'é‚„åŸ', 'å¾åˆªé™¤é …ç›®ä¸­é‚„åŸ'); }
    
    function updateTaskDb(id, data, logType, logDesc) {
        const task = state.tasks.find(t => t.id === id);
        const newLogs = task.logs || [];
        newLogs.unshift({ type: logType, desc: logDesc, user: state.currentUser.name, time: new Date().toISOString() });
        db.collection('tasks').doc(id).update({ ...data, logs: newLogs });
    }

    function changeDate(d, addHistory = true) {
        state.currentDate = d; document.getElementById('dateSearch').value = d;
        const dateObj = new Date(d);
        document.getElementById('headerDateDisplay').innerText = dateObj.toLocaleDateString('zh-TW', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        if(addHistory) {
            let hist = state.history.filter(x => x !== d); hist.unshift(d);
            if(hist.length > 10) hist.pop();
            state.history = hist; localStorage.setItem('tt_history', JSON.stringify(hist));
            renderHistory();
        }
        renderTasks();
    }
    function renderHistory() {
        const ul = document.getElementById('historyList'); ul.innerHTML = '';
        state.history.forEach(d => {
            const li = document.createElement('li'); li.className = `history-item ${d === state.currentDate?'active':''}`;
            li.innerText = d; li.onclick = () => { changeDate(d, false); if(window.innerWidth<=768) toggleSidebar(); };
            ul.appendChild(li);
        });
    }
    
    const storedUser = localStorage.getItem('tt_current_user');
    if(storedUser) { state.currentUser = JSON.parse(storedUser); initApp(); }
    
    function openModal(taskId=null) {
        // Prepare Dropdowns first
        populateSalesDropdowns();

        const modal=document.getElementById('taskModal'); const editor=document.getElementById('inputTitle');
        document.getElementById('taskModal').style.display='flex'; editor.focus();
        
        // Reset Form
        document.getElementById('ngs-form-container').style.display = 'none';
        document.getElementById('ngsUnit').value = '';
        document.getElementById('ngsPI').value = '';
        document.getElementById('ngsNeeds').value = '';
        document.getElementById('ngs-extraction-fields').style.display = 'none';
        document.getElementById('ngs-qc-fields').style.display = 'none';
        
        if(taskId) {
            state.editingTaskId=taskId; const t=state.tasks.find(x=>x.id===taskId);
            document.getElementById('modalTitle').innerText='ç·¨è¼¯ä»»å‹™å…§å®¹'; editor.innerHTML=t.title; document.getElementById('inputCategory').value=t.category;
            document.getElementById('btnSaveTask').innerText='ä¿å­˜ä¿®æ”¹';
            
            if (t.category === 'NGSæ”¶ä»¶' && t.details) {
                document.getElementById('ngs-form-container').style.display = 'block';
                document.getElementById('ngsUnit').value = t.details.unit || '';
                document.getElementById('ngsPI').value = t.details.pi || '';
                document.getElementById('ngsNeeds').value = t.details.needs || '';
                
                const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val||''; }
                const setDropdown = (selId, inpId, val, opts) => {
                    if(opts.includes(val)) { document.getElementById(selId).value=val; document.getElementById(inpId).style.display='none'; }
                    else { document.getElementById(selId).value='å…¶ä»–'; document.getElementById(inpId).style.display='block'; document.getElementById(inpId).value=val; }
                };

                if (t.details.needs === 'èƒå–') {
                    document.getElementById('ngs-extraction-fields').style.display = 'block';
                    setVal('ngsTemp', t.details.temp);
                    setVal('ngsReturn', t.details.returnBack);
                    setVal('ngsCount', t.details.sampleCount);
                    setVal('ngsSales', t.details.sales);
                    setDropdown('ngsSampleTypeSelect', 'ngsSampleTypeInput', t.details.sampleType, ['Cell','Blood','Tissue','Plant']);
                    setDropdown('ngsExpTypeSelect', 'ngsExpTypeInput', t.details.expType, ['Seq Only','DGE','Small RNA','WES','WGS','PIPseq','Amplicon Sequence','ç´°èŒWGS','metagenome','16s','16sFL','Olink','10x','RADseq']);
                    setDropdown('ngsPlatformSelect', 'ngsPlatformInput', t.details.platform, ['Novaseq X Plus','Miseq','PacBio','Nanopore','Olink']);
                } else if (t.details.needs === 'QC') {
                    document.getElementById('ngs-qc-fields').style.display = 'block';
                    setVal('ngsQcTemp', t.details.temp);
                    setVal('ngsQcReturn', t.details.returnBack);
                    setVal('ngsQcCount', t.details.sampleCount);
                    setVal('ngsQcSales', t.details.sales);
                    setDropdown('ngsNucleicTypeSelect', 'ngsNucleicTypeInput', t.details.nucleicType, ['DNA','RNA','Library','miRNA']);
                    setDropdown('ngsQcExpTypeSelect', 'ngsQcExpTypeInput', t.details.expType, ['Seq Only','DGE','Small RNA','WES','WGS','PIPseq','Amplicon Sequence','ç´°èŒWGS','metagenome','16s','16sFL','Olink','10x','RADseq']);
                    setDropdown('ngsQcPlatformSelect', 'ngsQcPlatformInput', t.details.platform, ['Novaseq X Plus','Miseq','PacBio','Nanopore','Olink']);
                }
            }
        } else {
            state.editingTaskId=null; document.getElementById('modalTitle').innerText='æ–°å¢æ¡ˆä»¶/ä»»å‹™'; editor.innerHTML='';
            document.getElementById('btnSaveTask').innerText='ç¢ºèªæ–°å¢';
            document.getElementById('inputCategory').value = 'å®šåºæ”¶ä»¶'; 
        }
    }
    function closeModal() { document.getElementById('taskModal').style.display='none'; state.editingTaskId=null; }
    function showHistory(id) {
        const t = state.tasks.find(x=>x.id===id); if(!t) return;
        const list = document.getElementById('logList'); list.innerHTML='';
        (t.logs||[]).forEach(l => {
            const d=new Date(l.time);
            const timeStr=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()}`;
            list.innerHTML+=`<li class="log-item"><div class="log-time">${timeStr}</div><div class="log-content"><span class="log-user">${l.user}</span> ${l.desc}</div></li>`;
        });
        document.getElementById('historyModal').style.display='flex';
    }
    document.getElementById('taskModal').addEventListener('click', e => { if(e.target.id==='taskModal') closeModal(); });
</script>
</body>
</html>
