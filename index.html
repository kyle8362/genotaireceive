<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>æ¡ˆä»¶é€²åº¦è¿½è¹¤ç³»çµ± (Client Search v32)</title>

    <script src="https://unpkg.com/firebase@9.22.2/firebase-app-compat.js"></script>
    <script src="https://unpkg.com/firebase@9.22.2/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #0f766e; --primary-light: #ccfbf1; --bg: #f3f4f6;
            --sidebar-bg: #ffffff; --text-main: #111827; --text-light: #6b7280;
            --border: #e5e7eb; --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --genesis: #7e22ce; --line-green: #06c755; --blue: #2563eb;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* Auth Screen */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .auth-box { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 320px; text-align: center; border: 1px solid var(--border); position: relative; }
        .auth-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: 600; font-size: 1rem; transition: background 0.3s; }
        .auth-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .switch-auth { margin-top: 15px; font-size: 0.9rem; color: var(--text-light); cursor: pointer; text-decoration: underline; }

        /* Layout */
        #app-screen { display: flex; width: 100%; height: 100%; position: relative; }
        #mobile-menu-btn { display: none; position: absolute; top: 15px; left: 15px; z-index: 1100; background: white; border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: var(--primary); }
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }
        aside { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem; box-sizing: border-box; transition: transform 0.3s ease; }
        
        .user-profile { display: flex; align-items: center; gap: 10px; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
        .avatar { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0; }
        .logout-link { font-size: 0.8rem; color: var(--danger); cursor: pointer; margin-top: 2px;}
        
        /* Sidebar Buttons */
        .sidebar-btn { padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; font-weight: 600; margin-bottom: 10px; display: block; font-size: 0.9rem; border: 1px solid transparent; width: 100%; }
        .sidebar-btn:hover { opacity: 0.9; }
        
        .btn-nav-active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-nav-inactive { background: white; color: var(--text-light); border: 1px solid var(--border); }
        
        .btn-perm { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .btn-stats { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        .btn-settings { background: #f0fdfa; color: #0f766e; border: 1px solid #ccfbf1; } 
        .btn-import { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        
        /* Client Search specific button */
        .btn-client-search { background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; }

        .sidebar-section h3 { font-size: 0.85rem; text-transform: uppercase; color: var(--text-light); letter-spacing: 1px; margin-bottom: 1rem; }
        input[type="date"] { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; color: var(--text-main); box-sizing: border-box; font-family: inherit; }
        .search-box input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }
        .search-results { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .search-item { padding: 8px; font-size: 0.85rem; border-bottom: 1px solid #f3f4f6; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .search-item:hover { background: #f9fafb; color: var(--primary); }
        
        /* Main Layout Switcher */
        main { flex-grow: 1; padding: 2rem; overflow-y: auto; position: relative; }
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        /* --- Task View Styles --- */
        header { margin-bottom: 2rem; }
        header h1 { margin: 0; font-size: 1.8rem; color: #111827; }
        .date-header { color: var(--text-light); margin-bottom: 0.5rem; font-weight: 500; }
        .overall-progress-container { margin-top: 15px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; color: #4b5563; }
        .progress-track { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.5s ease; }

        .task-container { max-width: 900px; padding-bottom: 100px; }
        .category-group { margin-bottom: 2.5rem; }
        .category-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .cat-title { color: var(--primary); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; }
        .badge-count { background: #e5e7eb; color: #374151; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; margin-left: 10px; }
        .cat-progress-track { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; margin-bottom: 1rem; }
        .cat-progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease; }

        details { margin-bottom: 10px; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden; background: white; }
        details summary { padding: 12px; cursor: pointer; font-weight: 600; background: #f9fafb; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        details summary:hover { background: #f3f4f6; color: var(--primary); }
        .details-content { padding: 10px; background: #fff; }
        .category-group.overdue-section .cat-title { color: #dc2626; } 
        .task-item { background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: flex-start; transition: all 0.2s; border-left: 4px solid transparent; position: relative; }
        .task-item:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); transform: translateY(-1px); }
        .task-item[data-cat="å®šåºæ”¶ä»¶"] { border-left-color: #3b82f6; }
        .task-item[data-cat="å¼•å­é€ä»¶"] { border-left-color: #8b5cf6; }
        .task-item[data-cat="ç”¢å‰æ”¶ä»¶"] { border-left-color: #ec4899; }
        .task-item[data-cat="æ¥­å‹™äº¤è¾¦äº‹é …"] { border-left-color: #f59e0b; }
        .task-item[data-cat="NGSæ”¶ä»¶"] { border-left-color: #0d9488; }
        .task-item.overdue-item { animation: blink-alert 2s infinite ease-in-out; border-left-width: 6px; }
        @keyframes blink-alert { 0% { border-left-color: #ef4444; } 50% { border-left-color: #b91c1c; } 100% { border-left-color: #ef4444; } }
        
        .task-checkbox { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 5px; margin-right: 15px; cursor: pointer; flex-shrink: 0; display: grid; place-items: center; margin-top: 3px; }
        .task-checkbox:hover { border-color: var(--primary); }
        .task-content { flex-grow: 1; display: flex; flex-direction: column; padding-right: 10px; }
        .task-title { font-size: 1rem; line-height: 1.5; word-break: break-all; padding: 2px 4px; border-radius: 4px; cursor: pointer; }
        .task-meta { font-size: 0.8rem; color: var(--text-light); margin-top: 6px; line-height: 1.4; }
        .completed-info { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; display: inline-block; font-weight: 500; }
        .task-item.completed-item .task-title { color: #9ca3af; text-decoration: line-through; }
        .ngs-badge { display: inline-block; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; background: #fdfdfd; margin-right: 5px; margin-top: 3px; color: #555; }
        .action-area { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .btn-icon { background: none; border: 1px solid transparent; cursor: pointer; font-size: 1.2rem; padding: 2px 6px; color: #9ca3af; border-radius: 4px; }
        .btn-icon:hover { background-color: #f3f4f6; color: var(--text-main); border-color: #ddd; }
        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; font-size: 32px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s; z-index: 800; }
        .fab:hover { transform: scale(1.05); background: #0d9488; }

        /* --- Customer Location View Styles --- */
        .cust-header { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .cust-search-bar { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .btn-google-form { background: #4285F4; color: white; padding: 10px 15px; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border:none; cursor:pointer;}
        .btn-google-form:hover { background: #357ae8; }
        
        .cust-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .cust-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid var(--blue); transition: transform 0.2s; }
        .cust-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .cust-unit { color: var(--blue); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .cust-name { font-size: 1.2rem; font-weight: 800; color: #111827; margin-bottom: 8px; }
        .cust-loc { font-size: 1rem; color: #374151; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .cust-contact { background: #f3f4f6; padding: 6px 10px; border-radius: 4px; font-size: 0.9rem; color: #4b5563; margin-bottom: 8px; }
        .cust-note { font-size: 0.85rem; color: #6b7280; font-style: italic; margin-bottom: 8px; border-left: 2px solid #ddd; padding-left: 8px; }
        .cust-update { font-size: 0.75rem; color: #9ca3af; text-align: right; margin-top: 10px; }
        .loading-spinner { text-align: center; padding: 20px; font-size: 1.2rem; color: var(--primary); }

        /* Modals & Others */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2100; justify-content: center; align-items: center; }
        .modal-card { background: white; padding: 2rem; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow-y: auto; }
        .editor-toolbar { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; padding: 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-bottom: none; border-radius: 6px 6px 0 0; align-items: center; }
        .tool-btn { padding: 4px 8px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; margin-bottom: 4px;}
        .color-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 1px solid #ddd; }
        .separator { width: 1px; height: 20px; background: #cbd5e1; margin: 0 4px; }
        select.tool-select { padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; }
        #inputTitle { width: 100%; min-height: 80px; padding: 15px; border: 1px solid #d1d5db; border-radius: 0 0 6px 6px; box-sizing: border-box; font-size: 1rem; background: white; outline: none; overflow-y: auto; }
        #inputTitle:focus { border-color: var(--primary); }
        .input-group { margin-bottom: 1.2rem; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
        .input-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }
        .input-group input[type="text"] { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        /* NGS Form, Import Area etc. from v30 styles */
        #ngs-form-container { background: #f0fdfa; padding: 15px; border: 1px solid #ccfbf1; border-radius: 8px; margin-bottom: 15px; display: none; }
        .ngs-row { margin-bottom: 10px; }
        .ngs-row label { font-size: 0.85rem; color: #0f766e; font-weight: 600; margin-bottom: 4px; display: block; }
        .ngs-row input, .ngs-row select { width: 100%; padding: 8px; border: 1px solid #5eead4; border-radius: 4px; font-size: 0.95rem; }
        #ngs-extraction-fields, #ngs-qc-fields { margin-top: 10px; padding-left: 10px; border-left: 3px solid #0d9488; display: none; }
        #importTextarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; font-size: 0.9rem; white-space: pre; overflow: auto; }
        .import-guide { font-size: 0.85rem; color: #666; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 4px; border: 1px solid #eee; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 12px; margin-top: 1.5rem; }
        .btn { padding: 9px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.95rem; }
        .btn-cancel { background: #f3f4f6; color: #4b5563; }
        .btn-save { background: var(--primary); color: white; }

        @media (max-width: 768px) {
            #mobile-menu-btn { display: block; }
            #sidebar-overlay { display: none; }
            #sidebar-overlay.active { display: block; }
            aside { position: fixed; top: 0; left: 0; height: 100%; width: 280px; z-index: 1000; transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            aside.open { transform: translateX(0); }
            main { padding-top: 70px; width: 100%; }
            .task-item { flex-direction: column; }
            .task-content { padding-right: 0; margin-bottom: 10px; }
            .action-area { flex-direction: row; width: 100%; justify-content: flex-end; }
            .fab { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 28px; }
            .cust-header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<button id="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="auth-screen">
    <div class="auth-box" id="authBox">
        <h2 id="auth-title" style="color:#0f766e">ç³»çµ±ç™»å…¥</h2>
        <input type="text" id="username" placeholder="å¸³è™Ÿ" autofocus>
        <input type="password" id="password" placeholder="å¯†ç¢¼">
        <button class="auth-btn" id="btnAuthAction" onclick="handleAuth()">ç™»å…¥</button>
        <div class="switch-auth" id="switchAuthLink" onclick="toggleAuthMode()">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Šæ–°å¸³è™Ÿ</div>
    </div>
</div>

<div id="app-screen" style="display:none;">
    <aside>
        <div class="user-profile">
            <div class="avatar" id="userAvatar">U</div>
            <div>
                <div style="font-weight: 600;" id="displayUsername">User</div>
                <div class="logout-link" onclick="logout()">ç™»å‡ºå¸³è™Ÿ</div>
            </div>
        </div>
        
        <button class="sidebar-btn btn-nav-active" id="btnTabTasks" onclick="switchTab('tasks')">ğŸ“‹ ä»»å‹™çœ‹æ¿</button>
        <button class="sidebar-btn btn-client-search" id="btnTabCustomers" onclick="switchTab('customers')">ğŸ¢ å®¢æˆ¶ä½ç½®æŸ¥è©¢</button>
        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">

        <div class="admin-btn btn-perm" id="adminPanelBtn" onclick="openUserModal()">ğŸ‘¥ æˆå“¡æ¬Šé™ç®¡ç†</div>
        <div class="admin-btn btn-settings" id="salesSettingsBtn" onclick="openSalesSettings()">âš™ï¸ NGS æ¥­å‹™è¨­å®š</div>
        <div class="admin-btn btn-import" id="importBtn" onclick="openImportModal()">ğŸ“¥ æ‰¹é‡åŒ¯å…¥ä»»å‹™</div>
        <div class="admin-btn btn-stats" id="statsPanelBtn" onclick="openStatsModal()">ğŸ“Š ä»»å‹™å®Œæˆçµ±æ•´</div>
        
        <div class="sidebar-section" id="taskSearchSection">
            <h3>ğŸ” æœå°‹ä»»å‹™</h3>
            <div class="search-box">
                <input type="text" id="searchTaskInput" placeholder="è¼¸å…¥é—œéµå­—..." oninput="handleSearch()">
                <ul class="search-results" id="searchResults"></ul>
            </div>
        </div>

        <div class="sidebar-section" id="taskDateSection">
            <h3>ğŸ“… æ—¥æœŸé¸æ“‡</h3>
            <input type="date" id="dateSearch" onchange="changeDate(this.value)">
        </div>
    </aside>

    <main>
        <div id="taskView" class="view-section active">
            <header>
                <div class="date-header" id="headerDateDisplay"></div>
                <h1>æ¡ˆä»¶é€²åº¦ç®¡ç†</h1>
                <div class="overall-progress-container">
                    <div class="progress-label"><span>ç•¶æ—¥ç¸½å®Œæˆåº¦</span><span id="overallProgressText">0%</span></div>
                    <div class="progress-track"><div class="progress-fill" id="overallProgressBar" style="width: 0%"></div></div>
                </div>
            </header>
            <div class="task-container" id="taskListContainer"></div>
            <button class="fab" onclick="openModal()">+</button>
        </div>

        <div id="customerView" class="view-section">
            <header>
                <h1>å®¢æˆ¶ä½ç½®æŸ¥è©¢</h1>
                <div class="date-header">å³æ™‚æŸ¥è©¢ Google è©¦ç®—è¡¨è³‡æ–™</div>
            </header>
            <div class="cust-header">
                <input type="text" id="custSearchInput" class="cust-search-bar" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±ã€æ¨“å±¤æˆ–é—œéµå­—..." oninput="handleCustomerSearch()">
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSeeq6mOlxQW88SQQGeZA_N9HDnAl_kGlr4Y50n6oqPw5JrKvg/viewform?usp=dialog" target="_blank" class="btn-google-form">â• ç”³è«‹æ–°å¢/ä¿®æ”¹</a>
            </div>
            <div id="custLoading" class="loading-spinner" style="display:none;">
                â³ è³‡æ–™è®€å–ä¸­...
            </div>
            <div class="cust-list-container" id="customerList">
                </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="importModal">
    <div class="modal-card" style="width: 500px;">
        <h3 style="margin-top:0; color:#047857;">ğŸ“¥ ç°¡æ˜“æ‰¹é‡åŒ¯å…¥</h3>
        <div class="import-guide">è«‹å°‡ Excel ä¸­çš„ä»»å‹™åç¨±è¤‡è£½ï¼Œä¸¦è²¼åœ¨ä¸‹æ–¹ (ä¸€è¡Œä¸€ç­†)ã€‚</div>
        <textarea id="importTextarea" placeholder="ç¯„ä¾‹ï¼š&#10;å°å¤§é†«é™¢-é™³æ•™æˆ-WESæ”¶ä»¶&#10;é•·åºšé†«é™¢-æ—é†«å¸«-DNAèƒå–"></textarea>
        <div style="margin-top:15px;"><label style="font-weight:bold;">åŒ¯å…¥è‡³å“ªå€‹é …ç›®ï¼š</label><select id="importCategorySelect" style="width:100%; padding:8px; margin-top:5px; border-radius:4px; border:1px solid #ccc;"></select></div>
        <div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('importModal').style.display='none'">å–æ¶ˆ</button><button class="btn btn-save" onclick="processImport()">ç¢ºèªåŒ¯å…¥</button></div>
    </div>
</div>
<div class="modal-overlay" id="taskModal"><div class="modal-card"><h2 id="modalTitle" style="margin-top:0; color:#111827;">æ–°å¢æ¡ˆä»¶/ä»»å‹™</h2><div class="input-group"><label>æ­¸å±¬é …ç›®</label><select id="inputCategory" onchange="handleCategoryChange()"><option value="å®šåºæ”¶ä»¶">ğŸ“‚ å®šåºæ”¶ä»¶</option><option value="å¼•å­é€ä»¶">ğŸš€ å¼•å­é€ä»¶</option><option value="ç”¢å‰æ”¶ä»¶">ğŸ“¦ ç”¢å‰æ”¶ä»¶</option><option value="æ¥­å‹™äº¤è¾¦äº‹é …">ğŸ“‹ æ¥­å‹™äº¤è¾¦äº‹é …</option><option value="NGSæ”¶ä»¶">ğŸ§¬ NGS æ”¶ä»¶ (éœ€å¡«è©³ç´°è³‡æ–™)</option></select></div><div id="ngs-form-container"><h4 style="margin-top:0; color:#0f766e;">ğŸ“ NGS è©³ç´°è³‡æ–™ (å¿…å¡«)</h4><div class="ngs-row"><label>1. å–®ä½</label><input type="text" id="ngsUnit" placeholder="è¼¸å…¥å–®ä½" oninput="generateNgsTitle()"></div><div class="ngs-row"><label>2. ä¸»æŒäºº</label><input type="text" id="ngsPI" placeholder="è¼¸å…¥ä¸»æŒäºº" oninput="generateNgsTitle()"></div><div class="ngs-row"><label>3. æ¨£æœ¬è™•ç†éœ€æ±‚</label><select id="ngsNeeds" onchange="handleNgsNeedsChange(); generateNgsTitle()"><option value="">è«‹é¸æ“‡</option><option value="èƒå–">èƒå– (Extraction)</option><option value="QC">QC</option></select></div><div id="ngs-extraction-fields"><div class="ngs-row"><label>4-1.1 æª¢é«”ç¨®é¡</label><select id="ngsSampleTypeSelect" onchange="handleDropdownChange('ngsSampleTypeSelect', 'ngsSampleTypeInput')"><option value="Cell">Cell</option><option value="Blood">Blood</option><option value="Tissue">Tissue</option><option value="Plant">Plant</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsSampleTypeInput" placeholder="è«‹è¼¸å…¥æª¢é«”ç¨®é¡" style="display:none; margin-top:5px;"></div><div class="ngs-row"><label>4-1.2 ä¿å­˜æº«åº¦</label><select id="ngsTemp"><option value="å¸¸æº«">å¸¸æº«</option><option value="4Â°C">4Â°C</option><option value="-20Â°C">-20Â°C</option><option value="-80Â°C">-80Â°C</option></select></div><div class="ngs-row"><label>4-1.3 æ­¸é‚„</label><select id="ngsReturn"><option value="æ˜¯">æ˜¯</option><option value="å¦">å¦</option></select></div><div class="ngs-row"><label>4-1.4 æ¨£æœ¬æ•¸é‡</label><input type="text" id="ngsCount" placeholder="å¡«å¯«æ•¸é‡"></div><div class="ngs-row"><label>4-1.5 å¾ŒçºŒå¯¦é©—ç¨®é¡</label><select id="ngsExpTypeSelect" onchange="handleDropdownChange('ngsExpTypeSelect', 'ngsExpTypeInput'); generateNgsTitle()"><option value="">è«‹é¸æ“‡</option><option value="Seq Only">Seq Only</option><option value="DGE">DGE</option><option value="Small RNA">Small RNA</option><option value="WES">WES</option><option value="WGS">WGS</option><option value="PIPseq">PIPseq</option><option value="Amplicon Sequence">Amplicon Sequence</option><option value="ç´°èŒWGS">ç´°èŒWGS</option><option value="metagenome">metagenome</option><option value="16s">16s</option><option value="16sFL">16sFL</option><option value="Olink">Olink</option><option value="10x">10x</option><option value="RADseq">RADseq</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsExpTypeInput" placeholder="è¼¸å…¥ç¨®é¡" style="display:none; margin-top:5px;" oninput="generateNgsTitle()"></div><div class="ngs-row"><label>4-1.6 å¯¦é©—å¹³å°</label><select id="ngsPlatformSelect" onchange="handleDropdownChange('ngsPlatformSelect', 'ngsPlatformInput')"><option value="Novaseq X Plus">Novaseq X Plus</option><option value="Miseq">Miseq</option><option value="PacBio">PacBio</option><option value="Nanopore">Nanopore</option><option value="Olink">Olink</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsPlatformInput" placeholder="è¼¸å…¥å¹³å°" style="display:none; margin-top:5px;"></div><div class="ngs-row"><label>4-1.7 è² è²¬æ¥­å‹™</label><select id="ngsSales"></select></div></div><div id="ngs-qc-fields"><div class="ngs-row"><label>4-2.1 æ ¸é…¸ç¨®é¡</label><select id="ngsNucleicTypeSelect" onchange="handleDropdownChange('ngsNucleicTypeSelect', 'ngsNucleicTypeInput'); generateNgsTitle()"><option value="">è«‹é¸æ“‡</option><option value="DNA">DNA</option><option value="RNA">RNA</option><option value="Library">Library</option><option value="miRNA">miRNA</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsNucleicTypeInput" placeholder="è¼¸å…¥ç¨®é¡" style="display:none; margin-top:5px;" oninput="generateNgsTitle()"></div><div class="ngs-row"><label>4-2.2 ä¿å­˜æº«åº¦</label><select id="ngsQcTemp"><option value="å¸¸æº«">å¸¸æº«</option><option value="4Â°C">4Â°C</option><option value="-20Â°C">-20Â°C</option><option value="-80Â°C">-80Â°C</option></select></div><div class="ngs-row"><label>4-2.3 æ­¸é‚„</label><select id="ngsQcReturn"><option value="æ˜¯">æ˜¯</option><option value="å¦">å¦</option></select></div><div class="ngs-row"><label>4-2.4 æ¨£æœ¬æ•¸é‡</label><input type="text" id="ngsQcCount" placeholder="å¡«å¯«æ•¸é‡"></div><div class="ngs-row"><label>4-2.5 å¾ŒçºŒå¯¦é©—ç¨®é¡</label><select id="ngsQcExpTypeSelect" onchange="handleDropdownChange('ngsQcExpTypeSelect', 'ngsQcExpTypeInput')"><option value="">è«‹é¸æ“‡</option><option value="Seq Only">Seq Only</option><option value="DGE">DGE</option><option value="Small RNA">Small RNA</option><option value="WES">WES</option><option value="WGS">WGS</option><option value="PIPseq">PIPseq</option><option value="Amplicon Sequence">Amplicon Sequence</option><option value="ç´°èŒWGS">ç´°èŒWGS</option><option value="metagenome">metagenome</option><option value="16s">16s</option><option value="16sFL">16sFL</option><option value="Olink">Olink</option><option value="10x">10x</option><option value="RADseq">RADseq</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsQcExpTypeInput" placeholder="è¼¸å…¥ç¨®é¡" style="display:none; margin-top:5px;"></div><div class="ngs-row"><label>4-2.6 å¯¦é©—å¹³å°</label><select id="ngsQcPlatformSelect" onchange="handleDropdownChange('ngsQcPlatformSelect', 'ngsQcPlatformInput')"><option value="Novaseq X Plus">Novaseq X Plus</option><option value="Miseq">Miseq</option><option value="PacBio">PacBio</option><option value="Nanopore">Nanopore</option><option value="Olink">Olink</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsQcPlatformInput" placeholder="è¼¸å…¥å¹³å°" style="display:none; margin-top:5px;"></div><div class="ngs-row"><label>4-2.7 è² è²¬æ¥­å‹™</label><select id="ngsQcSales"></select></div></div></div><div class="input-group"><label>ä»»å‹™å…§å®¹ (é¸å–æ–‡å­—å¯ç·¨è¼¯æ¨£å¼)</label><div class="editor-toolbar"><button class="tool-btn" onclick="formatDoc('bold')" title="ç²—é«”"><b>B</b></button><div class="separator"></div><button class="tool-btn" onclick="formatDoc('foreColor', '#ef4444')" title="ç´…å­—"><span class="color-dot" style="background:#ef4444"></span></button><button class="tool-btn" onclick="formatDoc('foreColor', '#2563eb')" title="è—å­—"><span class="color-dot" style="background:#2563eb"></span></button><button class="tool-btn" onclick="formatDoc('foreColor', '#10b981')" title="ç¶ å­—"><span class="color-dot" style="background:#10b981"></span></button><button class="tool-btn" onclick="formatDoc('foreColor', '#000000')" title="é»‘å­—"><span class="color-dot" style="background:#000000"></span></button><div class="separator"></div><button class="tool-btn" onclick="formatDoc('hiliteColor', '#fecaca')" title="ç´…åº•" style="background:#fecaca">A</button><button class="tool-btn" onclick="formatDoc('hiliteColor', '#bfdbfe')" title="è—åº•" style="background:#bfdbfe">A</button><button class="tool-btn" onclick="formatDoc('hiliteColor', '#bbf7d0')" title="ç¶ åº•" style="background:#bbf7d0">A</button><button class="tool-btn" onclick="formatDoc('hiliteColor', '#ffffff')" title="ç„¡åº•" style="background:#fff">âœ•</button><div class="separator"></div><select class="tool-select" onchange="formatDoc('fontSize', this.value); this.value='';" title="å­—é«”å¤§å°"><option value="">å­—é«”å¤§å°</option><option value="2">å°</option><option value="3">ä¸­</option><option value="5">å¤§</option><option value="7">ç‰¹å¤§</option></select></div><div id="inputTitle" contenteditable="true" placeholder="è¼¸å…¥å…§å®¹..."></div></div><div class="modal-btns"><button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-save" id="btnSaveTask" onclick="saveTask()">ç¢ºèª</button></div></div></div>
<div class="modal-overlay" id="salesSettingsModal"><div class="modal-card" style="width: 450px;"><h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">âš™ï¸ NGS è² è²¬æ¥­å‹™è¨­å®š</h3><div style="display:flex; gap:10px; margin-bottom:15px;"><input type="text" id="newSalesName" placeholder="è¼¸å…¥æ–°æ¥­å‹™å§“å" style="flex-grow:1; padding:8px; border:1px solid #ccc; border-radius:4px;"><button class="btn btn-save" onclick="addSalesOption()">æ–°å¢</button></div><ul class="settings-list" id="salesOptionList"></ul><div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('salesSettingsModal').style.display='none'">é—œé–‰</button></div></div></div>
<div class="modal-overlay" id="historyModal"><div class="modal-card" style="width: 400px;"><h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“‹ ç·¨è¼¯/æ“ä½œç´€éŒ„</h3><ul class="log-list" id="logList"></ul><div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('historyModal').style.display='none'">é—œé–‰</button></div></div></div>
<div class="modal-overlay" id="userModal"><div class="modal-card" style="width: 650px;"><h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ‘¥ æˆå“¡æ¬Šé™ç®¡ç†</h3><p style="font-size:0.85rem; color:#666; margin-bottom:10px;"><span style="color:#7e22ce; font-weight:bold;">ğŸŸ£ å‰µä¸–ç¥</span>ï¼šæœ€é«˜æ¬Šé™ï¼Œä¸å¯è¢«ä¿®æ”¹ã€‚<br>é«˜ç´šç®¡ç†è€…å¯ç·¨è¼¯è³‡æ–™ï¼›ç®¡ç†è€…åƒ…èƒ½æ ¸å‡†ã€‚</p><ul class="user-list" id="userListDisplay"></ul><div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('userModal').style.display='none'">é—œé–‰</button></div></div></div>
<div class="modal-overlay" id="statsModal"><div class="modal-card" style="width: 700px;"><h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“Š ä»»å‹™å®Œæˆçµ±æ•´</h3><div class="stats-filter-row"><div><label style="font-size:0.8rem;">é–‹å§‹æ—¥æœŸ</label><input type="date" id="statsDateStart"></div><div><label style="font-size:0.8rem;">çµæŸæ—¥æœŸ</label><input type="date" id="statsDateEnd"></div><div><label style="font-size:0.8rem;">æª¢ç´¢å¸³è™Ÿ</label><select id="statsUserSelect"><option value="all">-- æ‰€æœ‰å¸³è™Ÿ (ç¸½è¦½) --</option></select></div><div style="display:flex; align-items:flex-end;"><button class="btn btn-save" onclick="updateStats()">æŸ¥è©¢</button></div></div><div class="stats-result-area" id="statsResultDisplay"></div><div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('statsModal').style.display='none'">é—œé–‰</button></div></div></div>

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyBPcmgaT4f3nfyJrJOXnAeYCwH19SwZvCA",
      authDomain: "tasktrack-app-206f8.firebaseapp.com",
      projectId: "tasktrack-app-206f8",
      storageBucket: "tasktrack-app-206f8.firebasestorage.app",
      messagingSenderId: "528459789330",
      appId: "1:528459789330:web:caca16ee7c2b4efa1754cb",
      measurementId: "G-7JHGQW385H"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ORDERED_CATEGORIES = ["å®šåºæ”¶ä»¶", "å¼•å­é€ä»¶", "ç”¢å‰æ”¶ä»¶", "æ¥­å‹™äº¤è¾¦äº‹é …", "NGSæ”¶ä»¶"];
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxq3nzO5zqbiZnD8pcptQ1Gnm-_2JB4DTS13sts3pWF5NyC7Ok6tt317w9alAOJBVNyYw/exec";

    let state = {
        currentUser: null, currentDate: getTodayStr(), activeTab: 'tasks',
        tasks: [], users: [], salesOptions: [], customers: [], 
        history: JSON.parse(localStorage.getItem('tt_history')||'[]'), editingTaskId: null
    };

    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function formatDoc(cmd, value) { document.execCommand(cmd, false, value); document.getElementById('inputTitle').focus(); }
    function getUserDisplayName(username) { const u = state.users.find(x => x.username === username); return (u && u.nickname) ? u.nickname : username; }
    function toggleSidebar() { document.querySelector('aside').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('active'); }

    /* --- TAB SWITCHING --- */
    function switchTab(tab) {
        state.activeTab = tab;
        document.getElementById('taskView').classList.remove('active');
        document.getElementById('customerView').classList.remove('active');
        
        document.getElementById('btnTabTasks').className = `sidebar-btn ${tab==='tasks'?'btn-nav-active':'btn-nav-inactive'}`;
        document.getElementById('btnTabCustomers').className = `sidebar-btn ${tab==='customers'?'btn-nav-active':'btn-nav-inactive'}`;
        
        if (tab === 'tasks') {
            document.getElementById('taskView').classList.add('active');
            document.getElementById('taskSearchSection').style.display = 'block';
            document.getElementById('taskDateSection').style.display = 'block';
        } else {
            document.getElementById('customerView').classList.add('active');
            document.getElementById('taskSearchSection').style.display = 'none';
            document.getElementById('taskDateSection').style.display = 'none';
            if(state.customers.length === 0) fetchCustomers(); // Fetch on first view
        }
        
        if(window.innerWidth <= 768) toggleSidebar();
    }

    /* --- REAL-TIME LISTENERS --- */
    db.collection('tasks').onSnapshot(snapshot => {
        state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if(state.activeTab === 'tasks') renderTasks();
    });
    db.collection('users').onSnapshot(snapshot => {
        state.users = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
        if(document.getElementById('userModal').style.display === 'flex') openUserModal();
        if (state.currentUser) {
            const me = state.users.find(u => u.username === state.currentUser.name);
            if (!me) { alert('æ‚¨çš„å¸³è™Ÿå·²è¢«ç§»é™¤ï¼Œå³å°‡å¼·åˆ¶ç™»å‡ºã€‚'); logout(); } 
            else if (state.currentUser.role !== me.role) { state.currentUser.role = me.role; localStorage.setItem('tt_current_user', JSON.stringify(state.currentUser)); updateUIForRole(); }
        }
    });
    db.collection('settings').doc('ngs_sales').onSnapshot(doc => {
        if(doc.exists) state.salesOptions = doc.data().list || ['Jeff', 'å»–è»’é€µ'];
        else { state.salesOptions = ['Jeff', 'å»–è»’é€µ']; db.collection('settings').doc('ngs_sales').set({ list: state.salesOptions }); }
        if(document.getElementById('salesSettingsModal').style.display === 'flex') openSalesSettings();
    });

    /* --- CUSTOMER SEARCH (FETCH & RENDER) --- */
    async function fetchCustomers() {
        document.getElementById('custLoading').style.display = 'block';
        try {
            const res = await fetch(GAS_API_URL);
            const data = await res.json();
            state.customers = data;
            renderCustomers(data);
        } catch (e) {
            alert("è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API");
            console.error(e);
        } finally {
            document.getElementById('custLoading').style.display = 'none';
        }
    }

    function renderCustomers(data) {
        const container = document.getElementById('customerList');
        container.innerHTML = '';
        if(data.length === 0) { container.innerHTML = '<div style="color:#666;">æŸ¥ç„¡è³‡æ–™</div>'; return; }
        
        data.forEach(cust => {
            const div = document.createElement('div');
            div.className = 'cust-card';
            // Mapping: Assuming API returns keys like 'name', 'location', 'note', etc. 
            // Adapt if your API keys differ.
            const unit = cust.unit || cust.å–®ä½ || 'æœªåˆ†é¡';
            const name = cust.name || cust.å®¢æˆ¶åç¨± || 'ç„¡åç¨±';
            const loc = cust.location || cust.æ¨“å±¤ || cust.åœ°é» || '';
            const contact = cust.contact || cust.è¯çµ¡äºº || '';
            const note = cust.note || cust.å‚™è¨» || 'ç„¡å‚™è¨»';
            const update = cust.update || cust.æœ€å¾Œæ›´æ–° || '';

            div.innerHTML = `
                <div class="cust-unit">${unit}</div>
                <div class="cust-name">${name}</div>
                ${loc ? `<div class="cust-loc">ğŸ“ ${loc}</div>` : ''}
                ${contact ? `<div class="cust-contact">ğŸ“ ${contact}</div>` : ''}
                <div class="cust-note">${note}</div>
                ${update ? `<div class="cust-update">æ›´æ–°: ${update}</div>` : ''}
            `;
            container.appendChild(div);
        });
    }

    function handleCustomerSearch() {
        const key = document.getElementById('custSearchInput').value.trim().toLowerCase();
        if(!key) { renderCustomers(state.customers); return; }
        const filtered = state.customers.filter(c => {
            const str = JSON.stringify(c).toLowerCase();
            return str.includes(key);
        });
        renderCustomers(filtered);
    }

    /* --- Auth Logic --- */
    function toggleAuthMode() {
        const title = document.getElementById('auth-title'); const btn = document.getElementById('btnAuthAction'); const link = document.getElementById('switchAuthLink');
        if (title.innerText.includes('ç™»å…¥')) { title.innerText = 'è¨»å†Šæ–°å¸³è™Ÿ'; btn.innerText = 'è¨»å†Š'; link.innerText = 'å·²æœ‰å¸³è™Ÿï¼Ÿç™»å…¥'; } 
        else { title.innerText = 'ç³»çµ±ç™»å…¥'; btn.innerText = 'ç™»å…¥'; link.innerText = 'æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Šæ–°å¸³è™Ÿ'; }
    }
    async function handleAuth() {
        const u = document.getElementById('username').value.trim(); const p = document.getElementById('password').value.trim();
        const title = document.getElementById('auth-title').innerText; const btn = document.getElementById('btnAuthAction');
        if(!u || !p) return alert('è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼'); btn.disabled = true;
        try {
            if (title.includes('è¨»å†Š')) {
                if (u.toLowerCase() === 'admin') throw new Error('ä¸å¯ä½¿ç”¨ Admin ä½œç‚ºå¸³è™Ÿ');
                const q = await db.collection('users').where('username', '==', u).get(); if (!q.empty) throw new Error('å¸³è™Ÿå·²å­˜åœ¨');
                await db.collection('users').add({ username: u, password: p, isApproved: false, role: 'user', remarks: '', nickname: '' });
                alert('è¨»å†ŠæˆåŠŸï¼å¾…ç®¡ç†å“¡æ ¸å‡†å¾Œæ–¹å¯ç™»å…¥ã€‚'); toggleAuthMode();
            } else {
                if (u === 'Admin' && p === 'Abcd1234') {
                    const q = await db.collection('users').where('username', '==', 'Admin').get();
                    if(q.empty) await db.collection('users').add({ username: 'Admin', password: p, isApproved: true, role: 'creator', remarks: 'å‰µä¸–ç¥', nickname: 'ç³»çµ±ç®¡ç†å“¡' });
                    else { const docId = q.docs[0].id; if(q.docs[0].data().role !== 'creator') await db.collection('users').doc(docId).update({ role: 'creator' }); }
                    loginSuccess('Admin', 'creator');
                } else {
                    const q = await db.collection('users').where('username', '==', u).where('password', '==', p).get();
                    if (q.empty) alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'); else { const user = q.docs[0].data(); if (!user.isApproved) alert('âš ï¸ æ‚¨çš„å¸³è™Ÿå°šæœªé€šéå¯©æ ¸ã€‚'); else loginSuccess(user.username, user.role || 'user'); }
                }
            }
        } catch (e) { alert(e.message || 'ç™¼ç”ŸéŒ¯èª¤'); console.error(e); } finally { btn.disabled = false; }
    }
    function loginSuccess(username, role) { state.currentUser = { name: username, role: role }; localStorage.setItem('tt_current_user', JSON.stringify(state.currentUser)); initApp(); }
    function logout() { localStorage.removeItem('tt_current_user'); location.reload(); }
    
    function initApp() {
        document.getElementById('auth-screen').style.display = 'none'; document.getElementById('app-screen').style.display = 'flex';
        updateUIForRole(); changeDate(state.currentDate, false);
    }
    function updateUIForRole() {
        if(!state.currentUser) return;
        let roleName = '';
        if(state.currentUser.role === 'creator') roleName = ' (å‰µä¸–ç¥)'; else if(state.currentUser.role === 'senior') roleName = ' (é«˜ç´šç®¡ç†è€…)'; else if(state.currentUser.role === 'admin') roleName = ' (ç®¡ç†è€…)';
        const dispName = getUserDisplayName(state.currentUser.name);
        document.getElementById('displayUsername').innerText = dispName + roleName; document.getElementById('userAvatar').innerText = dispName[0].toUpperCase();
        const canManage = ['creator','senior','admin'].includes(state.currentUser.role);
        const canConfig = ['creator','senior'].includes(state.currentUser.role);
        document.getElementById('adminPanelBtn').style.display = canManage ? 'block' : 'none';
        document.getElementById('statsPanelBtn').style.display = canConfig ? 'block' : 'none';
        document.getElementById('salesSettingsBtn').style.display = canConfig ? 'block' : 'none';
        document.getElementById('importBtn').style.display = canManage ? 'block' : 'none';
    }

    /* --- IMPORT & SETTINGS --- */
    function openImportModal() {
        const select = document.getElementById('importCategorySelect'); select.innerHTML = '';
        ORDERED_CATEGORIES.forEach(cat => { if (cat !== 'NGSæ”¶ä»¶') { const opt = document.createElement('option'); opt.value = cat; opt.innerText = cat; select.appendChild(opt); } });
        document.getElementById('importModal').style.display = 'flex'; document.getElementById('importTextarea').value = '';
    }
    async function processImport() {
        const raw = document.getElementById('importTextarea').value.trim(); const cat = document.getElementById('importCategorySelect').value;
        if(!raw) return alert("è«‹è¼¸å…¥å…§å®¹");
        const lines = raw.split('\n'); let successCount = 0;
        for (let i = 0; i < lines.length; i++) {
            const title = lines[i].trim(); if(!title) continue;
            try { await db.collection('tasks').add({ category: cat, title: title, details: null, date: state.currentDate, completed: false, isDeleted: false, logs: [{ type: 'åŒ¯å…¥', desc: 'æ‰¹é‡åŒ¯å…¥', user: state.currentUser.name, time: new Date().toISOString() }], createdAt: new Date().toISOString() }); successCount++; } catch(e) { console.error(e); }
        }
        alert(`åŒ¯å…¥å®Œæˆï¼æˆåŠŸ: ${successCount}`); document.getElementById('importModal').style.display = 'none';
    }
    function openSalesSettings() {
        const list = document.getElementById('salesOptionList'); list.innerHTML = '';
        state.salesOptions.forEach((opt, index) => { const li = document.createElement('li'); li.className = 'setting-item'; li.innerHTML = `<span>${opt}</span><div><button class="btn-icon" onclick="editSalesOption(${index})">âœï¸</button><button class="btn-icon" style="color:red;" onclick="deleteSalesOption(${index})">ğŸ—‘ï¸</button></div>`; list.appendChild(li); });
        document.getElementById('salesSettingsModal').style.display = 'flex';
    }
    function saveSalesSettings() { db.collection('settings').doc('ngs_sales').update({ list: state.salesOptions }); }
    function addSalesOption() { const val = document.getElementById('newSalesName').value.trim(); if(val) { state.salesOptions.push(val); saveSalesSettings(); document.getElementById('newSalesName').value = ''; } }
    function deleteSalesOption(index) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { state.salesOptions.splice(index, 1); saveSalesSettings(); } }
    function editSalesOption(index) { const newVal = prompt("ä¿®æ”¹:", state.salesOptions[index]); if(newVal && newVal.trim()) { state.salesOptions[index] = newVal.trim(); saveSalesSettings(); } }
    function populateSalesDropdowns() { const optsHtml = state.salesOptions.map(s => `<option value="${s}">${s}</option>`).join(''); const s1 = document.getElementById('ngsSales'); const s2 = document.getElementById('ngsQcSales'); if(s1) s1.innerHTML = optsHtml; if(s2) s2.innerHTML = optsHtml; }

    /* --- TASKS LOGIC --- */
    function handleSearch() {
        const keyword = document.getElementById('searchTaskInput').value.trim().toLowerCase();
        const resultsContainer = document.getElementById('searchResults'); resultsContainer.innerHTML = '';
        if (!keyword) return;
        const matched = state.tasks.filter(t => t.title.replace(/<[^>]*>/g, '').toLowerCase().includes(keyword));
        matched.slice(0, 20).forEach(t => {
            const li = document.createElement('li'); li.className = 'search-item';
            li.innerHTML = `<span>${t.title.replace(/<[^>]*>/g, '')}</span><span class="search-date">${t.date}</span>`;
            li.onclick = () => { changeDate(t.date); if(window.innerWidth<=768) toggleSidebar(); };
            resultsContainer.appendChild(li);
        });
        if(matched.length === 0) resultsContainer.innerHTML = '<li class="search-item" style="color:#999; cursor:default;">ç„¡ç›¸ç¬¦çµæœ</li>';
    }

    /* --- NGS LOGIC --- */
    function handleCategoryChange() { const cat = document.getElementById('inputCategory').value; document.getElementById('ngs-form-container').style.display = (cat === 'NGSæ”¶ä»¶') ? 'block' : 'none'; }
    function handleNgsNeedsChange() { const needs = document.getElementById('ngsNeeds').value; document.getElementById('ngs-extraction-fields').style.display = (needs === 'èƒå–') ? 'block' : 'none'; document.getElementById('ngs-qc-fields').style.display = (needs === 'QC') ? 'block' : 'none'; }
    function handleDropdownChange(selectId, inputId) { document.getElementById(inputId).style.display = (document.getElementById(selectId).value === 'å…¶ä»–') ? 'block' : 'none'; }
    function generateNgsTitle() {
        const cat = document.getElementById('inputCategory').value; if (cat !== 'NGSæ”¶ä»¶') return;
        const unit = document.getElementById('ngsUnit').value.trim(); const pi = document.getElementById('ngsPI').value.trim(); const needs = document.getElementById('ngsNeeds').value;
        let subType = '';
        if (needs === 'èƒå–') { const sel = document.getElementById('ngsExpTypeSelect').value; subType = (sel === 'å…¶ä»–') ? document.getElementById('ngsExpTypeInput').value.trim() : sel; }
        else if (needs === 'QC') { const sel = document.getElementById('ngsNucleicTypeSelect').value; subType = (sel === 'å…¶ä»–') ? document.getElementById('ngsNucleicTypeInput').value.trim() : sel; }
        if (unit && pi && subType) document.getElementById('inputTitle').innerText = `${unit}-${pi}-${subType} æ”¶ä»¶`;
    }

    /* --- STATS --- */
    function openStatsModal() {
        const modal = document.getElementById('statsModal'); const userSelect = document.getElementById('statsUserSelect'); const startInput = document.getElementById('statsDateStart'); const endInput = document.getElementById('statsDateEnd');
        userSelect.innerHTML = '<option value="all">-- æ‰€æœ‰å¸³è™Ÿ (ç¸½è¦½) --</option>';
        const uniqueUsers = [...new Set(state.tasks.filter(t=>t.completed && t.completedBy).map(t=>t.completedBy))];
        uniqueUsers.sort().forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.innerText = getUserDisplayName(u); userSelect.appendChild(opt); });
        const year = new Date().getFullYear(); startInput.value = `${year}-01-01`; endInput.value = `${year}-12-31`;
        updateStats(); modal.style.display = 'flex';
    }
    function updateStats() {
        const start = document.getElementById('statsDateStart').value; const end = document.getElementById('statsDateEnd').value;
        const selectedUser = document.getElementById('statsUserSelect').value; const display = document.getElementById('statsResultDisplay'); display.innerHTML = '';
        if(!start || !end) return;
        const validTasks = state.tasks.filter(t => !t.completed || t.isDeleted || !t.completedBy ? false : (t.date >= start && t.date <= end));
        if (selectedUser === 'all') {
            const userCounts = {}; let total = 0;
            validTasks.forEach(t => { if(!userCounts[t.completedBy]) userCounts[t.completedBy]=0; userCounts[t.completedBy]++; total++; });
            if(total === 0) { display.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æ­¤å€é–“ç„¡å®Œæˆè³‡æ–™</div>'; return; }
            Object.entries(userCounts).sort((a,b)=>b[1]-a[1]).forEach(([user, count]) => {
                const pct = Math.round((count/total)*100);
                const card = document.createElement('div'); card.className = 'stat-card';
                card.innerHTML = `<div class="stat-header"><span>${getUserDisplayName(user)}</span> <span>${count} ä»¶</span></div><div class="stat-bar-container"><div class="stat-label"><span>ä½”æ¯”</span><span>${pct}%</span></div><div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div></div>`;
                display.appendChild(card);
            });
        } else {
            const userTasks = validTasks.filter(t => t.completedBy === selectedUser); const total = userTasks.length;
            if(total === 0) { display.innerHTML = `<div style="text-align:center; padding:20px; color:#888;">å¸³è™Ÿ ${getUserDisplayName(selectedUser)} åœ¨æ­¤å€é–“ç„¡å®Œæˆè³‡æ–™</div>`; return; }
            const catCounts = {}; ORDERED_CATEGORIES.forEach(c => catCounts[c]=0);
            userTasks.forEach(t => { if(catCounts[t.category]!==undefined) catCounts[t.category]++; });
            const card = document.createElement('div'); card.className = 'stat-card';
            card.innerHTML = `<div class="stat-header" style="border-bottom:1px solid #eee; padding-bottom:5px;">${getUserDisplayName(selectedUser)} - ç¸½è¨ˆ ${total} ä»¶</div>`;
            ORDERED_CATEGORIES.forEach(cat => {
                const count = catCounts[cat]; const pct = total===0?0:Math.round((count/total)*100);
                card.innerHTML += `<div style="margin-top:10px;"><div class="stat-label"><span>${cat}</span><span>${count} (${pct}%)</span></div><div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div></div>`;
            });
            display.appendChild(card);
        }
    }

    /* --- USER MANAGEMENT --- */
    function openUserModal() {
        const list = document.getElementById('userListDisplay'); const myRole = state.currentUser.role; list.innerHTML = '';
        state.users.forEach(user => {
            const li = document.createElement('li'); li.className = 'user-item';
            let badgeClass = 'role-user'; let badgeText = 'ä¸€èˆ¬è€…';
            if(user.role === 'creator') { badgeClass = 'role-creator'; badgeText = 'ğŸŸ£ å‰µä¸–ç¥'; }
            else if(user.role === 'senior') { badgeClass = 'role-senior'; badgeText = 'é«˜ç´šç®¡ç†è€…'; }
            else if(user.role === 'admin') { badgeClass = 'role-admin'; badgeText = 'ç®¡ç†è€…'; }
            if(!user.isApproved) { badgeClass = ''; badgeText = 'å¾…å¯©æ ¸'; }
            
            const isTargetCreator = user.role === 'creator';
            let controlsHtml = '';
            if (myRole === 'creator' || myRole === 'senior') {
                if (myRole === 'senior' && isTargetCreator) {
                     controlsHtml = `<div class="user-edit-row"><span style="color:purple; font-weight:bold;">æ­¤ç‚ºæœ€é«˜æ¬Šé™å¸³è™Ÿï¼Œç„¡æ³•ç·¨è¼¯ã€‚</span></div>`;
                } else {
                    const selUser = user.role === 'user' ? 'selected' : '';
                    const selAdmin = user.role === 'admin' ? 'selected' : '';
                    const selSenior = user.role === 'senior' ? 'selected' : '';
                    const roleSelect = (myRole==='creator' && isTargetCreator) ? `<select disabled><option>å‰µä¸–ç¥</option></select>` : `<select id="role_${user.docId}"><option value="user" ${selUser}>ä¸€èˆ¬è€…</option><option value="admin" ${selAdmin}>ç®¡ç†è€…</option><option value="senior" ${selSenior}>é«˜ç´šç®¡ç†è€…</option></select>`;
                    
                    controlsHtml = `
                        <div class="user-edit-row">${roleSelect}<input type="text" id="note_${user.docId}" placeholder="å‚™è¨»" value="${user.remarks || ''}" style="width:50%"><input type="text" id="nick_${user.docId}" placeholder="ç¨±è¬‚ (é¸å¡«)" value="${user.nickname || ''}" style="width:30%"></div>
                        <div class="user-edit-row"><span class="readonly-text">å¯†ç¢¼:</span><input type="password" id="pwd_${user.docId}" value="${user.password}" readonly style="background:#eee;color:#555;"><button class="btn-icon-eye" onclick="togglePasswordVisibility('pwd_${user.docId}')">ğŸ‘ï¸</button></div>
                        <div style="text-align:right;"><button class="btn-approve" onclick="updateUser('${user.docId}')">${user.isApproved?'æ›´æ–°è³‡æ–™':'æ ¸å‡†/æ›´æ–°'}</button>${!isTargetCreator ? `<button class="btn-reject" onclick="deleteUser('${user.docId}')">åˆªé™¤</button>` : ''}</div>
                    `;
                }
            } else {
                let actionBtn = !user.isApproved ? `<button class="btn-approve" onclick="approveUserSimple('${user.docId}')">æ ¸å‡†ç”³è«‹</button>` : `<span style="color:#10b981; font-size:0.85rem;">å·²æ ¸å‡†</span>`;
                controlsHtml = `<div class="user-edit-row"><span class="readonly-text">è§’è‰²: ${badgeText}</span><span class="readonly-text" style="margin-left:15px;">å‚™è¨»: ${user.remarks || '(ç„¡)'}</span></div><div style="text-align:right;">${actionBtn}</div>`;
            }
            li.innerHTML = `<div class="user-header"><div><span class="user-name">${user.username}</span><span class="user-role-badge ${badgeClass}">${badgeText}</span></div></div>${controlsHtml}`;
            list.appendChild(li);
        });
        document.getElementById('userModal').style.display = 'flex';
    }
    function togglePasswordVisibility(id) { const input = document.getElementById(id); input.type = input.type === "password" ? "text" : "password"; }
    function updateUser(docId) {
        const role = document.getElementById(`role_${docId}`).value; const note = document.getElementById(`note_${docId}`).value; const nick = document.getElementById(`nick_${docId}`).value;
        db.collection('users').doc(docId).update({ role: role, remarks: note, nickname: nick, isApproved: true }).then(() => alert('è³‡æ–™å·²æ›´æ–°'));
    }
    function deleteUser(docId) { if(confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) db.collection('users').doc(docId).delete().then(() => openUserModal()); }
    function approveUserSimple(docId) { db.collection('users').doc(docId).update({ isApproved: true }).then(() => alert('å·²æ ¸å‡†')); }

    /* --- TASKS RENDER --- */
    function renderTasks() {
        const container = document.getElementById('taskListContainer'); container.innerHTML = '';
        
        const overdueTasks = state.tasks.filter(t => t.date < state.currentDate && !t.completed && !t.isDeleted);
        if (overdueTasks.length > 0) {
            const group = document.createElement('div'); group.className = 'category-group overdue-section';
            group.innerHTML = `<div class="category-header-row"><div class="cat-title">ğŸš¨ å…ˆå‰æœªå®Œæˆ <span class="badge-count" style="background:#fee2e2; color:#b91c1c;">${overdueTasks.length}</span></div></div>`;
            overdueTasks.sort((a,b)=>new Date(a.date)-new Date(b.date));
            overdueTasks.forEach(t => group.appendChild(createTaskElement(t, true)));
            container.appendChild(group);
        }

        const dayTasks = state.tasks.filter(t => t.date === state.currentDate);
        const totalActive = dayTasks.filter(t => !t.isDeleted).length;
        const totalDone = dayTasks.filter(t => !t.isDeleted && t.completed).length;
        const totalPct = totalActive===0?0:Math.round((totalDone/totalActive)*100);
        document.getElementById('overallProgressText').innerText = `${totalDone}/${totalActive} (${totalPct}%)`;
        document.getElementById('overallProgressBar').style.width = `${totalPct}%`;

        if (dayTasks.length === 0 && overdueTasks.length === 0) { container.innerHTML += `<div style="text-align:center; color:#9ca3b8; margin-top:60px;">æœ¬æ—¥ç„¡ä»»ä½•æ¡ˆä»¶æˆ–ä»»å‹™</div>`; return; }

        ORDERED_CATEGORIES.forEach(cat => {
            const all = dayTasks.filter(t => t.category === cat && !t.isDeleted);
            const active = all.filter(t => !t.completed);
            const pct = all.length===0?0:Math.round((all.filter(t=>t.completed).length/all.length)*100);
            
            const group = document.createElement('div'); group.className = 'category-group';
            group.innerHTML = `<div class="category-header-row"><div class="cat-title">${cat} <span class="badge-count">${active.length}</span></div><div style="font-size:0.8rem; color:#6b7280; font-weight:600;">${pct}%</div></div><div class="cat-progress-track"><div class="cat-progress-fill" style="width: ${pct}%"></div></div>`;
            if (active.length > 0) active.forEach(t => group.appendChild(createTaskElement(t)));
            else group.innerHTML += `<div style="font-size:0.9rem; color:#d1d5db; padding-left:10px; margin-bottom:10px;">ç„¡å¾…è¾¦äº‹é …</div>`;
            container.appendChild(group);
        });

        const completedTasks = dayTasks.filter(t => t.completed && !t.isDeleted);
        if (completedTasks.length > 0) {
            const compSection = document.createElement('div'); compSection.className = 'category-group completed-section';
            compSection.innerHTML = `<div class="category-header-row"><div class="cat-title">âœ… å·²å®Œæˆé …ç›® (ç¸½è¦½) <span class="badge-count">${completedTasks.length}</span></div></div>`;
            ORDERED_CATEGORIES.forEach(cat => {
                const subTasks = completedTasks.filter(t => t.category === cat);
                if (subTasks.length > 0) {
                    const details = document.createElement('details');
                    details.innerHTML = `<summary>${cat} (${subTasks.length})</summary><div class="details-content"></div>`;
                    const content = details.querySelector('.details-content');
                    subTasks.sort((a,b)=>new Date(a.completedAt)-new Date(b.completedAt));
                    subTasks.forEach(t => content.appendChild(createTaskElement(t)));
                    compSection.appendChild(details);
                }
            });
            container.appendChild(compSection);
        }

        const deletedTasks = dayTasks.filter(t => t.isDeleted);
        if (deletedTasks.length > 0) {
            const delSection = document.createElement('div'); delSection.className = 'category-group deleted-section';
            delSection.innerHTML = `<div class="category-header-row"><div class="cat-title">ğŸ—‘ï¸ è¢«åˆªé™¤é …ç›® (ç¸½è¦½) <span class="badge-count">${deletedTasks.length}</span></div></div>`;
            ORDERED_CATEGORIES.forEach(cat => {
                const subTasks = deletedTasks.filter(t => t.category === cat);
                if (subTasks.length > 0) {
                    const details = document.createElement('details');
                    details.innerHTML = `<summary>${cat} (${subTasks.length})</summary><div class="details-content"></div>`;
                    const content = details.querySelector('.details-content');
                    subTasks.forEach(t => content.appendChild(createTaskElement(t)));
                    delSection.appendChild(details);
                }
            });
            container.appendChild(delSection);
        }
    }

    function createTaskElement(task, isOverdue = false) {
        const div = document.createElement('div');
        const overdueClass = isOverdue ? 'overdue-item' : '';
        div.className = `task-item ${overdueClass} ${task.completed ? 'completed-item' : ''} ${task.isDeleted ? 'deleted-item' : ''}`;
        div.setAttribute('data-cat', task.category);
        
        let checkboxHtml = task.isDeleted ? '' : `<div class="task-checkbox" onclick="toggleTask('${task.id}')"></div>`;
        let metaHtml = '';
        if (task.completed && !task.isDeleted) {
            const d = new Date(task.completedAt);
            const userDisp = getUserDisplayName(task.completedBy);
            metaHtml = `<div class="task-meta">åŸå§‹åˆ†é¡: ${task.category}<br><span class="completed-info">${userDisp} æ–¼ ${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')} å®Œæˆ</span></div>`;
        } else if (isOverdue) {
            metaHtml = `<div class="task-meta"><span class="task-overdue-date">å»ºç«‹æ–¼: ${task.date}</span></div>`;
        }

        let ngsInfoHtml = '';
        if (task.details) {
            ngsInfoHtml += `<div style="margin-top:5px; padding:5px; background:#f0fdfa; border-radius:4px; font-size:0.8rem; color:#0f766e;"><div><span class="ngs-badge">å–®ä½</span> ${task.details.unit}</div><div><span class="ngs-badge">ä¸»æŒäºº</span> ${task.details.pi}</div><div><span class="ngs-badge">éœ€æ±‚</span> ${task.details.needs}</div>`;
            if(task.details.needs === 'èƒå–') {
                ngsInfoHtml += `<div><span class="ngs-badge">ç¨®é¡</span> ${task.details.sampleType} | æ•¸é‡:${task.details.sampleCount}</div><div><span class="ngs-badge">å¾ŒçºŒ</span> ${task.details.expType} | å¹³å°:${task.details.platform}</div><div><span class="ngs-badge">æ¥­å‹™</span> ${task.details.sales} | æ­¸é‚„:${task.details.returnBack} | ${task.details.temp}</div>`;
            } else if (task.details.needs === 'QC') {
                ngsInfoHtml += `<div><span class="ngs-badge">æ ¸é…¸</span> ${task.details.nucleicType} | æ•¸é‡:${task.details.sampleCount}</div><div><span class="ngs-badge">å¾ŒçºŒ</span> ${task.details.expType} | å¹³å°:${task.details.platform}</div><div><span class="ngs-badge">æ¥­å‹™</span> ${task.details.sales} | æ­¸é‚„:${task.details.returnBack} | ${task.details.temp}</div>`;
            }
            ngsInfoHtml += `</div>`;
        }
        
        let actionBtn = task.isDeleted 
            ? `<button class="btn-icon btn-restore" onclick="restoreTask('${task.id}')">â†© é‚„åŸ</button>`
            : `<button class="btn-icon btn-delete" onclick="deleteTask('${task.id}')">Ã—</button>`;
            
        let lineBtnHtml = '';
        const canNotify = ['creator', 'senior', 'admin'].includes(state.currentUser.role);
        
        if (canNotify && !task.isDeleted) {
            let lineText = '';
            if (task.category === 'NGSæ”¶ä»¶' && task.details) {
                lineText = `ã€NGSæ¡ˆä»¶é€šçŸ¥ã€‘\nå–®ä½: ${task.details.unit}\nä¸»æŒäºº: ${task.details.pi}\né …ç›®: ${task.details.needs === 'èƒå–' ? task.details.expType : task.details.nucleicType}\nè² è²¬æ¥­å‹™: ${task.details.sales}`;
            } else {
                const plainTitle = task.title.replace(/<[^>]*>/g, '');
                lineText = `ã€ä»»å‹™é€šçŸ¥ã€‘\n${plainTitle}`;
            }
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Desktop: Show Copy (Always)
            if (!isMobile) {
                 lineBtnHtml += `<button onclick="copyToClipboard(\`${lineText.replace(/`/g, '\\`')}\`)" class="btn-icon btn-copy" title="è¤‡è£½é€šçŸ¥æ–‡å­—">ğŸ“‹</button>`;
            }

            // Mobile: Show LINE
            if (isMobile) {
                const encodedText = encodeURIComponent(lineText);
                lineBtnHtml += `<a href="https://line.me/R/share?text=${encodedText}" target="_blank" class="btn-icon btn-line" style="text-decoration:none;" title="LINEé€šçŸ¥">ğŸ’¬</a>`;
            }
        }

        const clickEvent = (!task.isDeleted) ? `onclick="openModal('${task.id}')"` : '';
        div.innerHTML = `${checkboxHtml}<div class="task-content"><div class="task-title" ${clickEvent}>${task.title}</div>${ngsInfoHtml}${metaHtml}</div><div class="action-area">${lineBtnHtml}<div class="history-dot" onclick="showHistory('${task.id}')">â‹®</div>${actionBtn}</div>`;
        return div;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => alert("å·²è¤‡è£½é€šçŸ¥å…§å®¹ï¼")).catch(err => prompt("è«‹æ‰‹å‹•è¤‡è£½:", text));
    }
    
    // ... (Keep existing Helper Functions: toggleTask, getDropdownOrInput, saveTask, deleteTask, restoreTask, updateTaskDb, changeDate, renderHistory, openModal, closeModal, showHistory) ...
    // Note: Re-paste full blocks for helper functions here if needed, but for brevity assuming they are carried over from v30/v31 logic exactly as is.
    function toggleTask(id) { const task = state.tasks.find(t => t.id === id); if(task) { const newVal = !task.completed; updateTaskDb(id, { completed: newVal, completedBy: newVal ? state.currentUser.name : null, completedAt: newVal ? new Date().toISOString() : null }, newVal ? 'å®Œæˆ' : 'é‡å•Ÿ', newVal ? 'æ¨™è¨˜ç‚ºå®Œæˆ' : 'å–æ¶ˆå®Œæˆç‹€æ…‹'); } }
    function getDropdownOrInput(selectId, inputId) { const sel = document.getElementById(selectId).value; return (sel === 'å…¶ä»–') ? document.getElementById(inputId).value.trim() : sel; }
    function saveTask() { 
        const htmlContent = document.getElementById('inputTitle').innerHTML.trim(); const category = document.getElementById('inputCategory').value;
        const textContent = document.getElementById('inputTitle').innerText.trim();
        if(textContent === '' && !htmlContent.includes('<img')) return alert('è«‹è¼¸å…¥ä»»å‹™å…§å®¹');
        let details = null;
        if (category === 'NGSæ”¶ä»¶') {
            const unit = document.getElementById('ngsUnit').value.trim(); const pi = document.getElementById('ngsPI').value.trim(); const needs = document.getElementById('ngsNeeds').value;
            if (!unit || !pi || !needs) return alert('è«‹å®Œæ•´å¡«å¯« NGS è©³ç´°è³‡æ–™');
            details = { unit, pi, needs };
            if (needs === 'èƒå–' || needs === 'QC') {
                const prefix = needs === 'èƒå–' ? 'ngs' : 'ngsQc';
                if (needs === 'èƒå–') { details.sampleType = getDropdownOrInput('ngsSampleTypeSelect', 'ngsSampleTypeInput'); if (!details.sampleType) return alert('è«‹å¡«å¯«æª¢é«”ç¨®é¡'); }
                else { details.nucleicType = getDropdownOrInput('ngsNucleicTypeSelect', 'ngsNucleicTypeInput'); if (!details.nucleicType) return alert('è«‹å¡«å¯«æ ¸é…¸ç¨®é¡'); }
                details.temp = document.getElementById(prefix + 'Temp').value; details.returnBack = document.getElementById(prefix + 'Return').value;
                details.sampleCount = document.getElementById(prefix + 'Count').value.trim(); details.expType = getDropdownOrInput(prefix + 'ExpTypeSelect', prefix + 'ExpTypeInput');
                details.platform = getDropdownOrInput(prefix + 'PlatformSelect', prefix + 'PlatformInput'); details.sales = document.getElementById(prefix + 'Sales').value;
                if (!details.sampleCount || !details.expType || !details.platform) return alert('è«‹å®Œæ•´å¡«å¯«è©³ç´°è³‡æ–™');
            }
        }
        if(state.editingTaskId) { updateTaskDb(state.editingTaskId, { title: htmlContent, category: category, details: details }, 'ä¿®æ”¹', 'ç·¨è¼¯ä»»å‹™å…§å®¹/åˆ†é¡'); } 
        else { const newTask = { title: htmlContent, category: category, date: state.currentDate, completed: false, isDeleted: false, logs: [], createdAt: new Date().toISOString(), details: details }; newTask.logs.push({ type: 'å»ºç«‹', desc: `å»ºç«‹ä»»å‹™æ–¼ [${category}]`, user: state.currentUser.name, time: new Date().toISOString() }); db.collection('tasks').add(newTask); }
        closeModal();
    }
    function deleteTask(id) { if(confirm('ç§»è‡³è¢«åˆªé™¤é …ç›®ï¼Ÿ')) updateTaskDb(id, { isDeleted: true }, 'åˆªé™¤', 'ç§»è‡³è¢«åˆªé™¤é …ç›®'); }
    function restoreTask(id) { updateTaskDb(id, { isDeleted: false }, 'é‚„åŸ', 'å¾åˆªé™¤é …ç›®ä¸­é‚„åŸ'); }
    function updateTaskDb(id, data, logType, logDesc) { const task = state.tasks.find(t => t.id === id); const newLogs = task.logs || []; newLogs.unshift({ type: logType, desc: logDesc, user: state.currentUser.name, time: new Date().toISOString() }); db.collection('tasks').doc(id).update({ ...data, logs: newLogs }); }
    function changeDate(d, addHistory = true) { state.currentDate = d; document.getElementById('dateSearch').value = d; const dateObj = new Date(d); document.getElementById('headerDateDisplay').innerText = dateObj.toLocaleDateString('zh-TW', {weekday:'long', year:'numeric', month:'long', day:'numeric'}); if(addHistory) { let hist = state.history.filter(x => x !== d); hist.unshift(d); if(hist.length > 10) hist.pop(); state.history = hist; localStorage.setItem('tt_history', JSON.stringify(hist)); renderHistory(); } renderTasks(); }
    function renderHistory() { const ul = document.getElementById('historyList'); ul.innerHTML = ''; state.history.forEach(d => { const li = document.createElement('li'); li.className = `history-item ${d === state.currentDate?'active':''}`; li.innerText = d; li.onclick = () => { changeDate(d, false); if(window.innerWidth<=768) toggleSidebar(); }; ul.appendChild(li); }); }
    const storedUser = localStorage.getItem('tt_current_user'); if(storedUser) { state.currentUser = JSON.parse(storedUser); initApp(); }
    function openModal(taskId=null) { populateSalesDropdowns(); const modal=document.getElementById('taskModal'); const editor=document.getElementById('inputTitle'); document.getElementById('taskModal').style.display='flex'; editor.focus(); document.getElementById('ngs-form-container').style.display = 'none'; document.getElementById('ngsUnit').value = ''; document.getElementById('ngsPI').value = ''; document.getElementById('ngsNeeds').value = ''; document.getElementById('ngs-extraction-fields').style.display = 'none'; document.getElementById('ngs-qc-fields').style.display = 'none'; if(taskId) { state.editingTaskId=taskId; const t=state.tasks.find(x=>x.id===taskId); document.getElementById('modalTitle').innerText='ç·¨è¼¯ä»»å‹™å…§å®¹'; editor.innerHTML=t.title; document.getElementById('inputCategory').value=t.category; document.getElementById('btnSaveTask').innerText='ä¿å­˜ä¿®æ”¹'; if (t.category === 'NGSæ”¶ä»¶' && t.details) { document.getElementById('ngs-form-container').style.display = 'block'; document.getElementById('ngsUnit').value = t.details.unit || ''; document.getElementById('ngsPI').value = t.details.pi || ''; document.getElementById('ngsNeeds').value = t.details.needs || ''; const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val||''; }; const setDropdown = (selId, inpId, val, opts) => { if(opts.includes(val)) { document.getElementById(selId).value=val; document.getElementById(inpId).style.display='none'; } else { document.getElementById(selId).value='å…¶ä»–'; document.getElementById(inpId).style.display='block'; document.getElementById(inpId).value=val; } }; if (t.details.needs === 'èƒå–') { document.getElementById('ngs-extraction-fields').style.display = 'block'; setVal('ngsTemp', t.details.temp); setVal('ngsReturn', t.details.returnBack); setVal('ngsCount', t.details.sampleCount); setVal('ngsSales', t.details.sales); setDropdown('ngsSampleTypeSelect', 'ngsSampleTypeInput', t.details.sampleType, ['Cell','Blood','Tissue','Plant']); setDropdown('ngsExpTypeSelect', 'ngsExpTypeInput', t.details.expType, ['Seq Only','DGE','Small RNA','WES','WGS','PIPseq','Amplicon Sequence','ç´°èŒWGS','metagenome','16s','16sFL','Olink','10x','RADseq']); setDropdown('ngsPlatformSelect', 'ngsPlatformInput', t.details.platform, ['Novaseq X Plus','Miseq','PacBio','Nanopore','Olink']); } else if (t.details.needs === 'QC') { document.getElementById('ngs-qc-fields').style.display = 'block'; setVal('ngsQcTemp', t.details.temp); setVal('ngsQcReturn', t.details.returnBack); setVal('ngsQcCount', t.details.sampleCount); setVal('ngsQcSales', t.details.sales); setDropdown('ngsNucleicTypeSelect', 'ngsNucleicTypeInput', t.details.nucleicType, ['DNA','RNA','Library','miRNA']); setDropdown('ngsQcExpTypeSelect', 'ngsQcExpTypeInput', t.details.expType, ['Seq Only','DGE','Small RNA','WES','WGS','PIPseq','Amplicon Sequence','ç´°èŒWGS','metagenome','16s','16sFL','Olink','10x','RADseq']); setDropdown('ngsQcPlatformSelect', 'ngsQcPlatformInput', t.details.platform, ['Novaseq X Plus','Miseq','PacBio','Nanopore','Olink']); } } } else { state.editingTaskId=null; document.getElementById('modalTitle').innerText='æ–°å¢æ¡ˆä»¶/ä»»å‹™'; editor.innerHTML=''; document.getElementById('btnSaveTask').innerText='ç¢ºèªæ–°å¢'; document.getElementById('inputCategory').value = 'å®šåºæ”¶ä»¶'; } }
    function closeModal() { document.getElementById('taskModal').style.display='none'; state.editingTaskId=null; }
    function showHistory(id) { const t = state.tasks.find(x=>x.id===id); if(!t) return; const list = document.getElementById('logList'); list.innerHTML=''; (t.logs||[]).forEach(l => { const d=new Date(l.time); const timeStr=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()}`; const userDisp = getUserDisplayName(l.user); list.innerHTML+=`<li class="log-item"><div class="log-time">${timeStr}</div><div class="log-content"><span class="log-user">${userDisp}</span> ${l.desc}</div></li>`; }); document.getElementById('historyModal').style.display='flex'; }
    document.getElementById('taskModal').addEventListener('click', e => { if(e.target.id==='taskModal') closeModal(); });
</script>
</body>
</html>
