<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡ˆä»¶é€²åº¦è¿½è¹¤ç³»çµ± (Final v16)</title>

    <style>
        :root { --primary: #0f766e; --bg: #f3f4f6; --text: #111827; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; margin: 0; }
        
        /* Debug Console */
        #debug-console { position: fixed; bottom: 10px; right: 10px; width: 350px; height: 200px; background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; border-radius: 8px; z-index: 9999; overflow-y: auto; pointer-events: none; border: 1px solid #333; }
        .log-err { color: #ff4444; font-weight:bold; } .log-succ { color: #00ff00; } .log-warn { color: #ffbb33; }

        /* Simplified Auth UI for Debugging */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .auth-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 300px; text-align: center; border: 1px solid #ddd; }
        .auth-box input { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .auth-btn { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .auth-btn:disabled { background: #999; }
        
        /* App Layout */
        #app-screen { display: none; width: 100%; height: 100%; }
        aside { width: 260px; background: white; border-right: 1px solid #ddd; padding: 20px; display: flex; flex-direction: column; }
        main { flex: 1; padding: 20px; overflow-y: auto; }
        .task-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid #ccc; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .task-item[data-cat="å®šåºæ”¶ä»¶"] { border-left-color: #3b82f6; }
        .task-item[data-cat="å¼•å­é€ä»¶"] { border-left-color: #8b5cf6; }
        .task-item[data-cat="ç”¢å‰æ”¶ä»¶"] { border-left-color: #ec4899; }
        .task-item[data-cat="æ¥­å‹™äº¤è¾¦äº‹é …"] { border-left-color: #f59e0b; }
        .btn-icon { cursor: pointer; border: none; background: none; color: #888; font-size: 1.2em; float: right; }
    </style>

    <script src="https://unpkg.com/firebase@9.22.2/firebase-app-compat.js" onerror="scriptLoadError('firebase-app')"></script>
    <script src="https://unpkg.com/firebase@9.22.2/firebase-firestore-compat.js" onerror="scriptLoadError('firebase-firestore')"></script>

</head>
<body>

<div id="debug-console">ç³»çµ±å•Ÿå‹•ä¸­...<br>æ­£åœ¨å˜—è©¦é€£ç·š CDN...</div>

<div id="auth-screen">
    <h2 style="color:#0f766e">ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h2>
    <div class="auth-box">
        <div id="status-text" style="margin-bottom:15px; font-weight:bold; color:#666;">ç­‰å¾… Firebase è¼‰å…¥...</div>
        <input type="text" id="username" placeholder="å¸³è™Ÿ (Admin)" disabled>
        <input type="password" id="password" placeholder="å¯†ç¢¼ (Abcd1234)" disabled>
        <button class="auth-btn" id="loginBtn" onclick="tryLogin()" disabled>ç™»å…¥</button>
        <div style="margin-top:15px; font-size:0.8rem; color:#888;">
            <a href="#" onclick="toggleMode()">åˆ‡æ› è¨»å†Š/ç™»å…¥</a>
        </div>
    </div>
</div>

<div id="app-screen">
    <aside>
        <h3>åŠŸèƒ½é¸å–®</h3>
        <button class="auth-btn" onclick="logout()">ç™»å‡º</button>
        <div id="userInfo" style="margin-top:20px; font-weight:bold;"></div>
        <hr>
        <div style="font-size:0.8rem; color:#666;">è‹¥çœ‹åˆ°æ­¤ç•«é¢ï¼Œä»£è¡¨è³‡æ–™åº«å·²æˆåŠŸé€£ç·šï¼</div>
    </aside>
    <main id="taskListContainer">
        <h2>ä»»å‹™åˆ—è¡¨ (è³‡æ–™åº«é€£ç·šæ¸¬è©¦)</h2>
        <div id="loadingTasks">è¼‰å…¥ä»»å‹™ä¸­...</div>
    </main>
</div>

<script>
    // --- 0. éŒ¯èª¤æ•æ‰å·¥å…· ---
    function log(msg, type='') {
        const el = document.getElementById('debug-console');
        const c = type==='err'?'log-err':(type==='succ'?'log-succ':'');
        el.innerHTML += `<div class="${c}">> ${msg}</div>`;
        el.scrollTop = el.scrollHeight;
    }
    
    function scriptLoadError(name) {
        log(`åš´é‡éŒ¯èª¤: ${name}.js ç„¡æ³•è¼‰å…¥ï¼`, 'err');
        log(`å¯èƒ½åŸå› : å…¬å¸é˜²ç«ç‰†æ“‹ä½äº† unpkg.com`, 'warn');
        document.getElementById('status-text').innerText = "ğŸ”¥ ç¶²è·¯å°é–ï¼šç„¡æ³•è¼‰å…¥ç¨‹å¼åº«";
        document.getElementById('status-text').style.color = "red";
        alert(`ç„¡æ³•é€£ç·šåˆ°ç¨‹å¼åº«ä¸»æ©Ÿ (${name})ã€‚\nè«‹å˜—è©¦ä½¿ç”¨æ‰‹æ©Ÿç†±é»åˆ†äº«ç¶²è·¯ï¼Œæˆ–è¯çµ¡ IT é–‹æ”¾ unpkg.com`);
    }

    // --- 1. FIREBASE è¨­å®š (è«‹ç¢ºèªé€™è£¡æ˜¯å¦æ­£ç¢º) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBPcmgaT4f3nfyJrJOXnAeYCwH19SwZvCA",
      authDomain: "tasktrack-app-206f8.firebaseapp.com",
      projectId: "tasktrack-app-206f8",
      storageBucket: "tasktrack-app-206f8.firebasestorage.app",
      messagingSenderId: "528459789330",
      appId: "1:528459789330:web:caca16ee7c2b4efa1754cb",
      measurementId: "G-7JHGQW385H"
    };

    let db;
    let isRegisterMode = false;

    // --- 2. åˆå§‹åŒ– ---
    window.onload = function() {
        if (typeof firebase === 'undefined') {
            log("Firebase ç‰©ä»¶ä¸å­˜åœ¨ (Script Load Failed)", 'err');
            return;
        }

        try {
            log("æ­£åœ¨åˆå§‹åŒ– Firebase App...");
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            log("Firebase åˆå§‹åŒ–æˆåŠŸï¼", 'succ');
            
            // é–‹å•Ÿè¼¸å…¥æ¡†
            document.getElementById('username').disabled = false;
            document.getElementById('password').disabled = false;
            document.getElementById('loginBtn').disabled = false;
            document.getElementById('status-text').innerText = "âœ… ç³»çµ±å°±ç·’ï¼Œè«‹ç™»å…¥";
            document.getElementById('status-text').style.color = "green";

            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            const cached = localStorage.getItem('tt_user');
            if(cached) {
                log("ç™¼ç¾èˆŠç™»å…¥ç´€éŒ„ï¼Œè‡ªå‹•ç™»å…¥ä¸­...");
                const u = JSON.parse(cached);
                showApp(u);
            }

        } catch (e) {
            log("åˆå§‹åŒ–å¤±æ•—: " + e.message, 'err');
            document.getElementById('status-text').innerText = "âŒ è¨­å®šéŒ¯èª¤: " + e.message;
        }
    };

    // --- 3. ç™»å…¥/è¨»å†Š é‚è¼¯ ---
    function toggleMode() {
        isRegisterMode = !isRegisterMode;
        document.getElementById('loginBtn').innerText = isRegisterMode ? "è¨»å†Šä¸¦ç™»å…¥" : "ç™»å…¥";
        document.getElementById('status-text').innerText = isRegisterMode ? "ğŸ“ è¨»å†Šæ–°å¸³è™Ÿ" : "ğŸ”‘ ç”¨æˆ¶ç™»å…¥";
    }

    async function tryLogin() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        if(!u || !p) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");

        const btn = document.getElementById('loginBtn');
        btn.disabled = true;
        log(`${isRegisterMode?'è¨»å†Š':'ç™»å…¥'}è«‹æ±‚: ${u}...`);

        try {
            // ADMIN ç‰¹æ®Šé€šé“ (å¼·åˆ¶å»ºç«‹)
            if (u === 'Admin' && p === 'Abcd1234' && !isRegisterMode) {
                log("åµæ¸¬åˆ° Admin ç™»å…¥ï¼Œæª¢æŸ¥è³‡æ–™åº«...");
                const q = await db.collection('users').where('username', '==', 'Admin').get();
                if(q.empty) {
                    log("Admin ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆå§‹åŒ–...");
                    await db.collection('users').add({
                        username: 'Admin', password: p, role: 'senior', isApproved: true, remarks: 'System Owner'
                    });
                    log("Admin å¸³è™Ÿå»ºç«‹å®Œæˆ", 'succ');
                }
                const adminUser = { username: 'Admin', role: 'senior' };
                localStorage.setItem('tt_user', JSON.stringify(adminUser));
                showApp(adminUser);
                return;
            }

            // ä¸€èˆ¬é‚è¼¯
            if (isRegisterMode) {
                // è¨»å†Š
                const q = await db.collection('users').where('username', '==', u).get();
                if (!q.empty) throw new Error("å¸³è™Ÿå·²å­˜åœ¨");
                
                await db.collection('users').add({
                    username: u, password: p, role: 'user', isApproved: false, remarks: 'New User'
                });
                alert("è¨»å†ŠæˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡æ ¸å‡†å¾Œå†ç™»å…¥ã€‚");
                toggleMode(); // åˆ‡å›ç™»å…¥
            } else {
                // ç™»å…¥
                const q = await db.collection('users').where('username', '==', u).where('password', '==', p).get();
                if (q.empty) throw new Error("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
                
                const userData = q.docs[0].data();
                if (!userData.isApproved) throw new Error("æ­¤å¸³è™Ÿå°šæœªè¢«æ ¸å‡†");
                
                localStorage.setItem('tt_user', JSON.stringify(userData));
                showApp(userData);
            }

        } catch (e) {
            log("æ“ä½œå¤±æ•—: " + e.message, 'err');
            alert(e.message);
        } finally {
            btn.disabled = false;
        }
    }

    // --- 4. é¡¯ç¤ºä¸»ç¨‹å¼ (è®€å–è³‡æ–™) ---
    function showApp(user) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';
        document.getElementById('userInfo').innerText = `Hello, ${user.username} (${user.role || 'user'})`;
        log("é€²å…¥ä¸»ç¨‹å¼ï¼Œé–‹å§‹ç›£è½è³‡æ–™åº«...", 'succ');

        // ç›£è½ä»»å‹™
        db.collection('tasks').onSnapshot(snapshot => {
            const list = document.getElementById('taskListContainer');
            list.innerHTML = `<h2>ä»»å‹™åˆ—è¡¨ (${snapshot.size} ç­†)</h2>`;
            if(snapshot.empty) {
                list.innerHTML += "<p>ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œè«‹å…ˆåˆ‡æ›åˆ°ã€Œç®¡ç†å“¡ã€æˆ–åœ¨å®Œæ•´ç‰ˆæ–°å¢ä»»å‹™ã€‚</p>";
                return;
            }
            snapshot.forEach(doc => {
                const t = doc.data();
                const div = document.createElement('div');
                div.className = 'task-item';
                div.setAttribute('data-cat', t.category);
                div.innerHTML = `
                    <strong>${t.title}</strong> 
                    <span style="font-size:0.8rem; color:#666">(${t.date})</span>
                    <br><small>åˆ†é¡: ${t.category} | ç‹€æ…‹: ${t.completed?'å®Œæˆ':'æœªå®Œæˆ'}</small>
                `;
                list.appendChild(div);
            });
            log("è³‡æ–™åº«åŒæ­¥æˆåŠŸï¼", 'succ');
        }, err => {
            log("è³‡æ–™åº«è®€å–å¤±æ•—: " + err.message, 'err');
            alert("è®€å–å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ¬Šé™ä¸è¶³æˆ–ç¶²è·¯ä¸­æ–·");
        });
    }

    function logout() {
        localStorage.removeItem('tt_user');
        location.reload();
    }

</script>
</body>
</html>
